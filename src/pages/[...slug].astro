---
import BaseLayout from "../layouts/BaseLayout.astro";
import TreePage from "../components/TreePage.astro";
import { findNodeBySegments, getPathForNode, siteTree } from "../data/siteTree";
import { buildCollectionSchemaNodes, buildLeafSchemaNodes } from "../lib/geo";
import { withLang } from "../lib/i18n";
import { getPageUpdatedIso } from "../lib/page-updates";
import { absoluteUrl } from "../lib/site";
import type { TreeNode } from "../data/siteTree";
export const getStaticPaths = () => {
  const paths: string[] = [];
  const walk = (node: TreeNode, prefix: string[] = []) => {
    if (!node.children) return;
    for (const child of node.children) {
      const next = [...prefix, child.slug];
      paths.push(next.join("/"));
      walk(child, next);
    }
  };
  walk(siteTree);
  return paths.map((slug) => ({ params: { slug } }));
};

const { slug } = Astro.params;
const segments = slug ? slug.split("/") : [];
const lang = "en";
const { node } = findNodeBySegments(segments);
if (!node) {
  Astro.response.status = 404;
}
const parentPath = segments.length > 1 ? getPathForNode(segments.slice(0, -1)) : "/";
const breadcrumbs: { label: string; path: string }[] = [];
let cursor = siteTree;
let pathSegments: string[] = [];
for (const segment of segments) {
  const next = cursor.children?.find((child) => child.slug === segment);
  if (!next) break;
  pathSegments = [...pathSegments, segment];
  breadcrumbs.push({ label: next.title, path: withLang(`/${pathSegments.join("/")}`, lang) });
  cursor = next;
}

const ui = {
  en: {
    siteName: "Visit Korea Planner",
    notFound: "Page Not Found",
    notFoundDesc: "The page you are looking for does not exist.",
    goHome: "Go Home",
  },
  es: {
    siteName: "Planificador de viaje a Corea",
    notFound: "Página no encontrada",
    notFoundDesc: "La página que buscas no existe.",
    goHome: "Ir al inicio",
  },
} as const;

const ROUTE_META_DESCRIPTION_OVERRIDES: Record<string, string> = {
  "/plan-your-trip":
    "Trip lengths, pacing, and city flow in 7-14 days. Build a realistic Korea plan in about 10 minutes.",
  "/choose-a-city":
    "Compare Seoul, Busan, Jeju, and more in 5 minutes. Pick cities by travel style, pace, and transfer time.",
  "/getting-around-korea":
    "Subway, bus, taxi, and transport cards in 7 minutes. Typical subway rides start around 1,400 KRW in major cities.",
  "/what-to-eat":
    "Beginner-friendly Korean food picks in 5 minutes. Start with 5-7 core dishes before trying spicy options.",
  "/where-to-stay":
    "Choose the right area and stay style in 8 minutes. Mid-range hotels often run about 80,000-180,000 KRW per night.",
  "/things-to-do":
    "Top attractions, city highlights, and cost checks in 7 minutes. Many popular sights range from free to 20,000 KRW.",
  "/travel-basics":
    "SIM/eSIM setup, card vs cash, and safety basics in 5 minutes. Typical traveler SIM plans cost 15,000-30,000 KRW.",
  "/before-you-go":
    "Entry basics, documents, and airport flow in 6 minutes. Keep 3 essentials ready: passport, bookings, and entry requirements.",
  "/shopping-and-deals":
    "Shopping zones, tax refund flow, and discount tips in 6 minutes. Refund eligibility and rates vary by store and purchase amount.",
  "/latest-travel-updates-for-korea":
    "Track major Korea travel changes in under 3 minutes. Check again within 24 hours before departure.",
  "/korea-now-and-more":
    "Fast weekly Korea context in about 5 minutes. Use it to adjust plans with better local timing.",
  "/this-week-in-korea":
    "This week in Korea at a glance in about 2 minutes. A quick pre-departure and in-trip checkpoint.",
};

const t = ui[lang];
const routePath = segments.length ? `/${segments.join("/")}` : "/";
const routePathWithSlash = routePath === "/" ? "/" : `${routePath}/`;
const pageDescription =
  (node ? ROUTE_META_DESCRIPTION_OVERRIDES[routePath] : undefined) ??
  node?.description ??
  t.notFoundDesc;
const canonicalUrl = absoluteUrl(routePathWithSlash);
const alternateEnUrl = absoluteUrl(routePathWithSlash);
const alternateEsPath = withLang(routePath, "es");
const alternateEsUrl = absoluteUrl(
  alternateEsPath === "/" ? "/" : `${alternateEsPath.replace(/\/+$/, "")}/`
);

const pageTitle = node
  ? `${node.title} | ${t.siteName}`
  : `${t.notFound} | ${t.siteName}`;

const bodyClass = node ? (node.children && node.children.length > 0 ? "page--sub" : "page--leaf") : "page--sub";
const nodeForRender = node
  ? {
      ...node,
      updatedIso: getPageUpdatedIso(routePath, lang, node.updatedIso),
    }
  : undefined;
const schemaNodes = node
  ? nodeForRender!.children && nodeForRender!.children.length > 0
    ? buildCollectionSchemaNodes({
        canonicalUrl,
        routePath,
        node: nodeForRender!,
        lang,
        description: pageDescription,
      })
    : buildLeafSchemaNodes({
        canonicalUrl,
        node: nodeForRender!,
        lang,
        description: pageDescription,
        segments,
      })
  : [];
---

{node ? (
  <BaseLayout
    title={pageTitle}
    description={pageDescription}
    bodyClass={bodyClass}
    lang={lang}
    canonicalUrl={canonicalUrl}
    alternateEnUrl={alternateEnUrl}
    alternateEsUrl={alternateEsUrl}
    breadcrumbs={breadcrumbs}
    schemaNodes={schemaNodes}
    updatedIso={nodeForRender.updatedIso}
  >
    <TreePage
      node={nodeForRender}
      segments={segments}
      parentPath={withLang(parentPath, lang)}
      isHome={segments.length === 0}
      breadcrumbs={breadcrumbs}
      lang={lang}
    />
  </BaseLayout>
) : (
  <BaseLayout
    title={pageTitle}
    description={pageDescription}
    bodyClass="page--leaf"
    lang={lang}
    canonicalUrl={canonicalUrl}
    alternateEnUrl={alternateEnUrl}
    alternateEsUrl={alternateEsUrl}
    breadcrumbs={breadcrumbs}
    schemaNodes={schemaNodes}
    noindex
  >
    <section style="padding: 64px 0; text-align: center;">
      <h1 class="t-h1" style="font-family: Fraunces, serif;">{t.notFound}</h1>
      <p class="t-subheading" style="color: #5f6b84;">{t.notFoundDesc}</p>
      <a
        href={withLang("/", lang)}
        style="display: inline-flex; margin-top: 18px; padding: 10px 18px; border-radius: 999px; background: #1f6f8b; color: #fff;"
      >
        {t.goHome}
      </a>
    </section>
  </BaseLayout>
)}
