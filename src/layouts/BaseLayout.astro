---
import { withLang, type SupportedLang } from "../lib/i18n";
import {
  absoluteUrl,
  DEFAULT_OG_IMAGE_ALT,
  DEFAULT_OG_IMAGE_PATH,
  SITE_NAME,
} from "../lib/site";
import {
  EDITORIAL_AUTHOR_NAME,
  EDITORIAL_REVIEWER_NAME,
  EDITORIAL_UPDATED_ISO,
} from "../lib/editorial";

type BreadcrumbItem = {
  label: string;
  path: string;
};

type JsonLdNode = Record<string, unknown>;

const {
  title = "Visit Korea Planner",
  description = "Practical travel guidance for foreigners visiting Korea.",
  bodyClass = "",
  lang = "en",
  canonicalUrl = absoluteUrl("/"),
  alternateEnUrl = absoluteUrl("/"),
  alternateEsUrl = absoluteUrl("/es/"),
  breadcrumbs = [],
  noindex = false,
  ogImage = absoluteUrl(DEFAULT_OG_IMAGE_PATH),
  ogImageAlt = DEFAULT_OG_IMAGE_ALT,
  schemaNodes = [],
} = Astro.props as {
  title?: string;
  description?: string;
  bodyClass?: string;
  lang?: SupportedLang;
  canonicalUrl?: string;
  alternateEnUrl?: string;
  alternateEsUrl?: string;
  breadcrumbs?: BreadcrumbItem[];
  noindex?: boolean;
  ogImage?: string;
  ogImageAlt?: string;
  schemaNodes?: JsonLdNode[];
};

const robotsContent = noindex
  ? "noindex, nofollow"
  : "index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1";
const locale = lang === "es" ? "es_ES" : "en_US";
const alternateLocale = lang === "es" ? "en_US" : "es_ES";
const siteName = lang === "es" ? "Planificador de viaje a Corea" : SITE_NAME;
const homeLabel = lang === "es" ? "Inicio" : "Home";
const localizedHomePath = withLang("/", lang);
const HOME_HERO_IMAGE_DESKTOP = "/hanok-hero-home.webp?v=20260210q";
const HOME_HERO_IMAGE_MOBILE = "/leaf%20images/thumbs/hanok_hero.webp?v=20260211a";
const gaMeasurementId = "G-VKP8CHGJKH";
const gaEnabled = true;
const footerLinks = [
  {
    path: withLang("/about", lang),
    label: lang === "es" ? "Acerca de" : "About",
  },
  {
    path: withLang("/privacy-policy", lang),
    label: lang === "es" ? "Política de privacidad" : "Privacy Policy",
  },
  {
    path: withLang("/contact", lang),
    label: lang === "es" ? "Contacto" : "Contact",
  },
  {
    path: withLang("/disclaimer", lang),
    label: lang === "es" ? "Descargo de responsabilidad" : "Disclaimer",
  },
];

const breadcrumbTrail = [{ label: homeLabel, path: localizedHomePath }, ...breadcrumbs].reduce(
  (acc, item) => {
    if (!item?.label || !item?.path) return acc;
    if (acc.some((existing) => existing.path === item.path)) return acc;
    acc.push(item);
    return acc;
  },
  [] as BreadcrumbItem[]
);

const schemaGraph: Record<string, unknown>[] = [
  {
    "@type": "Organization",
    "@id": `${absoluteUrl("/")}#organization`,
    url: absoluteUrl("/"),
    name: SITE_NAME,
    inLanguage: ["en", "es"],
  },
  {
    "@type": "WebSite",
    "@id": `${absoluteUrl("/")}#website`,
    url: absoluteUrl("/"),
    name: siteName,
    inLanguage: lang,
    publisher: { "@id": `${absoluteUrl("/")}#organization` },
  },
  {
    "@type": "WebPage",
    "@id": `${canonicalUrl}#webpage`,
    url: canonicalUrl,
    name: title,
    description,
    inLanguage: lang,
    isPartOf: { "@id": `${absoluteUrl("/")}#website` },
    about: [
      {
        "@type": "Thing",
        name:
          lang === "es"
            ? "Planificación de viajes a Corea del Sur"
            : "South Korea travel planning",
      },
    ],
    primaryImageOfPage: {
      "@type": "ImageObject",
      url: ogImage,
    },
    author: {
      "@type": "Organization",
      name: EDITORIAL_AUTHOR_NAME,
    },
    reviewedBy: {
      "@type": "Organization",
      name: EDITORIAL_REVIEWER_NAME,
    },
    dateModified: EDITORIAL_UPDATED_ISO,
  },
];

if (breadcrumbTrail.length > 1) {
  schemaGraph.push({
    "@type": "BreadcrumbList",
    "@id": `${canonicalUrl}#breadcrumb`,
    itemListElement: breadcrumbTrail.map((item, index) => ({
      "@type": "ListItem",
      position: index + 1,
      name: item.label,
      item: absoluteUrl(item.path),
    })),
  });
}

for (const node of schemaNodes) {
  if (node && typeof node === "object") {
    schemaGraph.push(node);
  }
}

const schemaJson = JSON.stringify({
  "@context": "https://schema.org",
  "@graph": schemaGraph,
});

---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <meta name="theme-color" content="#120E0B" />
    <meta name="robots" content={robotsContent} />
    <meta name="googlebot" content={robotsContent} />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <meta name="author" content={siteName} />
    <link rel="icon" href="/favicon.ico" />
    {gaEnabled ? (
      <>
        <script is:inline define:vars={{ gaMeasurementId }}>
          (() => {
            if (!gaMeasurementId) return;

            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            const effectiveType = typeof connection?.effectiveType === "string" ? connection.effectiveType : "";
            const shouldSkipForDataSavings = Boolean(connection?.saveData) || effectiveType.includes("2g");
            if (shouldSkipForDataSavings) return;

            const loadGaScript = () => {
              if (document.querySelector("script[data-ga-loader]")) return;
              const script = document.createElement("script");
              script.async = true;
              script.src = `https://www.googletagmanager.com/gtag/js?id=${gaMeasurementId}`;
              script.setAttribute("data-ga-loader", "true");
              script.setAttribute("fetchpriority", "low");
              document.head.appendChild(script);
            };

            let started = false;
            const options = { passive: true };
            const cleanup = () => {
              window.removeEventListener("pointerdown", startNow, options);
              window.removeEventListener("keydown", startNow, options);
              window.removeEventListener("touchstart", startNow, options);
              window.removeEventListener("scroll", startNow, options);
            };
            const startNow = () => {
              if (started) return;
              started = true;
              cleanup();
              loadGaScript();
            };

            window.addEventListener("pointerdown", startNow, options);
            window.addEventListener("keydown", startNow, options);
            window.addEventListener("touchstart", startNow, options);
            window.addEventListener("scroll", startNow, options);
            window.setTimeout(startNow, 15000);
          })();
        </script>
        <script is:inline>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-VKP8CHGJKH');
        </script>
        <script is:inline>
          (() => {
            const loadClarity = () => {
              if (window.__clarityLoaded) return;
              window.__clarityLoaded = true;
              (function(c,l,a,r,i,t,y){
                  c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
                  t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
                  y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
              })(window, document, "clarity", "script", "vf7k31hdmt");
            };

            let started = false;
            const options = { passive: true };
            const cleanup = () => {
              window.removeEventListener("pointerdown", startNow, options);
              window.removeEventListener("keydown", startNow, options);
              window.removeEventListener("touchstart", startNow, options);
              window.removeEventListener("scroll", startNow, options);
            };
            const startNow = () => {
              if (started) return;
              started = true;
              cleanup();
              loadClarity();
            };
            const startSoft = () => {
              if (started) return;
              if ("requestIdleCallback" in window) {
                window.requestIdleCallback(startNow, { timeout: 2800 });
                return;
              }
              window.setTimeout(startNow, 1400);
            };

            window.addEventListener("pointerdown", startNow, options);
            window.addEventListener("keydown", startNow, options);
            window.addEventListener("touchstart", startNow, options);
            window.addEventListener("scroll", startNow, options);

            if (document.readyState === "complete") {
              startSoft();
            } else {
              window.addEventListener("load", startSoft, { once: true });
            }
            window.setTimeout(startNow, 6500);
          })();
        </script>
      </>
    ) : null}
    {bodyClass.includes("home-bg") ? (
      <>
        <link
          rel="preload"
          as="image"
          href={HOME_HERO_IMAGE_MOBILE}
          media="(max-width: 720px)"
          fetchpriority="high"
        />
        <link
          rel="preload"
          as="image"
          href={HOME_HERO_IMAGE_DESKTOP}
          media="(min-width: 721px)"
          fetchpriority="high"
        />
      </>
    ) : null}
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
    <link rel="dns-prefetch" href="//fonts.gstatic.com" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="preload"
      as="style"
      href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;600;700&family=Plus+Jakarta+Sans:wght@600;700&family=Work+Sans:wght@300;400;500;600&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;600;700&family=Plus+Jakarta+Sans:wght@600;700&family=Work+Sans:wght@300;400;500;600&display=swap"
      media="print"
      onload="this.media='all'"
    />
    <noscript>
      <link
        rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;600;700&family=Plus+Jakarta+Sans:wght@600;700&family=Work+Sans:wght@300;400;500;600&display=swap"
      />
    </noscript>
    <meta name="description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:alt" content={ogImageAlt} />
    <meta property="og:locale" content={locale} />
    <meta property="og:locale:alternate" content={alternateLocale} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:url" content={canonicalUrl} />
    <meta name="twitter:image" content={ogImage} />
    <link rel="canonical" href={canonicalUrl} />
    <link rel="alternate" hreflang="en" href={alternateEnUrl} />
    <link rel="alternate" hreflang="es" href={alternateEsUrl} />
    <link rel="alternate" hreflang="x-default" href={alternateEnUrl} />
    <script type="application/ld+json" set:html={schemaJson} />
    <title>{title}</title>
    <style>
      :root {
        color-scheme: dark;
        --bg-0: #120e0b;
        --bg-1: #1a120e;
        --bg-2: #0f0b09;

        --text-strong: #f7f3ee;
        --text-soft: #e7e2da;
        --text-muted: #c9c1b6;

        --ink-strong: #171412;
        --ink-soft: #4a433c;

        --paper: #f5f0e8;
        --paper-2: #efe7dc;

        --border-dark: rgba(255, 255, 255, 0.1);
        --border-paper: rgba(23, 20, 18, 0.08);

        --shadow-1: 0 10px 24px rgba(0, 0, 0, 0.28);
        --shadow-2: 0 18px 44px rgba(0, 0, 0, 0.34);
        --radius-xl: 22px;

        --accent: #7c5cff;
        --accent-hover: #6a4ef0;

        --text: var(--text-strong);
        --muted: var(--text-muted);
        --ink: var(--ink-strong);
        --ring: rgba(124, 92, 255, 0.22);
        --shadow: var(--shadow-1);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Work Sans", system-ui, sans-serif;
        color: var(--text-soft);
        background:
          radial-gradient(1200px 600px at 20% -10%, rgba(255, 255, 255, 0.06), transparent 55%),
          linear-gradient(180deg, var(--bg-1), var(--bg-2));
        min-height: 100vh;
      }

      body.home-bg {
        background:
          radial-gradient(1300px 700px at 18% -6%, rgba(255, 244, 224, 0.22), transparent 56%),
          radial-gradient(900px 520px at 76% 86%, rgba(0, 0, 0, 0.26), transparent 62%),
          linear-gradient(180deg, rgba(24, 18, 14, 0.36), rgba(18, 14, 11, 0.6)),
          linear-gradient(180deg, rgba(26, 18, 14, 0.2), rgba(15, 11, 9, 0.46)),
          url("/hanok-hero-home.webp?v=20260210q") !important;
        background-size: cover !important;
        background-position: center !important;
        background-repeat: no-repeat !important;
      }

      @media (max-width: 720px) {
        body.home-bg {
          background:
            radial-gradient(1300px 700px at 18% -6%, rgba(255, 244, 224, 0.22), transparent 56%),
            radial-gradient(900px 520px at 76% 86%, rgba(0, 0, 0, 0.26), transparent 62%),
            linear-gradient(180deg, rgba(24, 18, 14, 0.36), rgba(18, 14, 11, 0.6)),
            linear-gradient(180deg, rgba(26, 18, 14, 0.2), rgba(15, 11, 9, 0.46)),
            url("/leaf%20images/thumbs/hanok_hero.webp?v=20260211a") !important;
          background-size: cover !important;
          background-position: center !important;
          background-repeat: no-repeat !important;
        }
      }

      body.page--sub main {
        background: transparent;
        border-radius: 0;
        border: none;
        box-shadow: none;
        padding: 48px 36px 80px;
      }

      body.page--leaf main {
        background: transparent;
        border-radius: 0;
        border: none;
        box-shadow: none;
        padding: 48px 36px 80px;
      }

      @media (max-width: 720px) {
        body.page--sub main,
        body.page--leaf main {
          padding: 32px 18px 64px;
        }
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      h1,
      h2,
      h3 {
        color: var(--text-strong);
      }

      p,
      li {
        color: var(--text-soft);
      }

      .small,
      .muted {
        color: var(--text-muted);
      }

      main {
        width: min(1100px, 92vw);
        margin: 0 auto;
        padding: 48px 0 80px;
      }

      .site-footer {
        width: min(1100px, 92vw);
        margin: 0 auto 34px;
        padding-top: 14px;
        border-top: 1px solid rgba(255, 255, 255, 0.18);
      }

      .site-footer-links {
        margin: 0;
        padding: 0;
        list-style: none;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
        gap: 18px;
      }

      .site-footer-links a {
        color: var(--text-soft);
        font-size: 0.95rem;
      }

      .site-footer-links a:hover {
        color: var(--text-strong);
      }

      .skip-link {
        position: absolute;
        left: -999px;
        top: 0;
      }

      .skip-link:focus {
        left: 16px;
        top: 16px;
        background: #fff;
        padding: 8px 12px;
        border-radius: 999px;
        box-shadow: var(--shadow);
      }

      @media (max-width: 720px) {
        main {
          padding: 32px 0 64px;
        }
      }

      #google_translate_element {
        position: absolute;
        width: 0;
        height: 0;
        overflow: hidden;
        opacity: 0;
        pointer-events: none;
      }

    </style>
    <style is:global>
      .goog-te-banner-frame.skiptranslate,
      iframe.goog-te-banner-frame,
      .goog-te-balloon-frame,
      #goog-gt-tt,
      .goog-tooltip {
        display: none !important;
        visibility: hidden !important;
      }

      body {
        top: 0 !important;
      }

      html.translated-ltr body.home-bg,
      html.translated-rtl body.home-bg,
      body.translated-ltr.home-bg,
      body.translated-rtl.home-bg {
        background:
          radial-gradient(1300px 700px at 18% -6%, rgba(255, 244, 224, 0.22), transparent 56%),
          radial-gradient(900px 520px at 76% 86%, rgba(0, 0, 0, 0.26), transparent 62%),
          linear-gradient(180deg, rgba(24, 18, 14, 0.36), rgba(18, 14, 11, 0.6)),
          linear-gradient(180deg, rgba(26, 18, 14, 0.2), rgba(15, 11, 9, 0.46)),
          url("/hanok-hero-home.webp?v=20260210q") !important;
        background-size: cover !important;
        background-position: center !important;
        background-repeat: no-repeat !important;
      }

      @media (max-width: 720px) {
        html.translated-ltr body.home-bg,
        html.translated-rtl body.home-bg,
        body.translated-ltr.home-bg,
        body.translated-rtl.home-bg {
          background:
            radial-gradient(1300px 700px at 18% -6%, rgba(255, 244, 224, 0.22), transparent 56%),
            radial-gradient(900px 520px at 76% 86%, rgba(0, 0, 0, 0.26), transparent 62%),
            linear-gradient(180deg, rgba(24, 18, 14, 0.36), rgba(18, 14, 11, 0.6)),
            linear-gradient(180deg, rgba(26, 18, 14, 0.2), rgba(15, 11, 9, 0.46)),
            url("/leaf%20images/thumbs/hanok_hero.webp?v=20260211a") !important;
          background-size: cover !important;
          background-position: center !important;
          background-repeat: no-repeat !important;
        }
      }

      html.translated-ltr body.home-bg .hero,
      html.translated-rtl body.home-bg .hero,
      body.translated-ltr.home-bg .hero,
      body.translated-rtl.home-bg .hero {
        background:
          linear-gradient(180deg, rgba(18, 14, 11, 0.24), rgba(15, 11, 9, 0.38)),
          url("/hanok-hero-home.webp?v=20260210q") center / cover no-repeat !important;
      }

      @media (max-width: 720px) {
        html.translated-ltr body.home-bg .hero,
        html.translated-rtl body.home-bg .hero,
        body.translated-ltr.home-bg .hero,
        body.translated-rtl.home-bg .hero {
          background:
            linear-gradient(180deg, rgba(18, 14, 11, 0.24), rgba(15, 11, 9, 0.38)),
            url("/leaf%20images/thumbs/hanok_hero.webp?v=20260211a") center / cover no-repeat !important;
        }
      }

      .page--sub,
      .page--leaf {
        --page-bg-top: #456A86;
        --page-bg-bot: #355468;
        --page-overlay: rgba(18, 14, 11, 0.22);

        --text: #FFFFFF;
        --text-soft: rgba(255, 255, 255, 0.86);
        --text-mute: rgba(255, 255, 255, 0.72);
        --text-muted: rgba(255, 255, 255, 0.72);

        --card-bg: #F5F0E8;
        --card-text: #2E2A26;
        --card-muted: rgba(46, 42, 38, 0.70);
        --card-border: rgba(255, 255, 255, 0.10);

        --thumb-bg-a: #F5F0E8;
        --thumb-bg-b: #EFE7DC;
        --thumb-mask-top: rgba(18, 14, 11, 0.16);
        --thumb-mask-bot: rgba(18, 14, 11, 0.02);

        --accent: #E6D3A3;
        --accent-text: #2E2A26;
        --focus: rgba(230, 211, 163, 0.45);
        --link-on-dark: #ffe3a3;
        --link-on-dark-hover: #fff2cf;
        --link-on-light: #0b5bd3;
        --link-on-light-hover: #08429a;

        --paper: var(--card-bg);
        --paper-2: var(--thumb-bg-b);
        --ink-strong: var(--card-text);
        --ink-soft: var(--card-muted);
        --border-paper: rgba(0, 0, 0, 0.06);
        --ring: var(--focus);

        background: linear-gradient(180deg, var(--page-bg-top) 0%, var(--page-bg-bot) 100%);
        color: var(--text);
        position: relative;
      }

      .page--sub::before,
      .page--leaf::before {
        content: "";
        position: absolute;
        inset: 0;
        background: var(--page-overlay);
        pointer-events: none;
        z-index: 0;
      }

      .page--sub > *,
      .page--leaf > * {
        position: relative;
        z-index: 1;
      }

      .page--sub a,
      .page--leaf a {
        color: var(--link-on-dark);
        text-decoration-color: rgba(255, 227, 163, 0.5);
        text-underline-offset: 0.18em;
      }

      .page--sub a:hover,
      .page--leaf a:hover {
        color: var(--link-on-dark-hover);
        text-decoration-color: rgba(255, 242, 207, 0.74);
      }

      .page--sub .section.light a,
      .page--leaf .section.light a,
      .page--sub .answer a,
      .page--leaf .answer a,
      .page--sub .content-block a,
      .page--leaf .content-block a,
      .page--sub .leaf-tools a,
      .page--leaf .leaf-tools a {
        color: var(--link-on-light);
        text-decoration-color: rgba(11, 91, 211, 0.45);
      }

      .page--sub .section.light a:hover,
      .page--leaf .section.light a:hover,
      .page--sub .answer a:hover,
      .page--leaf .answer a:hover,
      .page--sub .content-block a:hover,
      .page--leaf .content-block a:hover,
      .page--sub .leaf-tools a:hover,
      .page--leaf .leaf-tools a:hover {
        color: var(--link-on-light-hover);
        text-decoration-color: rgba(8, 66, 154, 0.62);
      }

      .page--sub .muted,
      .page--leaf .muted {
        color: var(--text-mute);
      }

      .page--sub :focus-visible,
      .page--leaf :focus-visible {
        outline: 3px solid var(--focus);
        outline-offset: 3px;
        border-radius: 12px;
      }

      .page--sub .panel,
      .page--leaf .panel {
        background: rgba(0, 0, 0, 0.22);
        border: 1px solid rgba(255, 255, 255, 0.10);
        border-radius: 28px;
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.25);
      }

      .page--sub .card,
      .page--leaf .card {
        background: var(--card-bg);
        color: var(--card-text);
        border: 1px solid rgba(0, 0, 0, 0.06);
        border-radius: 22px;
        box-shadow: 0 18px 45px rgba(0, 0, 0, 0.2);
      }

      .page--sub .card p,
      .page--leaf .card p {
        color: var(--card-muted);
      }

      .page--sub .card:hover,
      .page--leaf .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 22px 60px rgba(0, 0, 0, 0.22);
      }

      .page--sub .thumb,
      .page--leaf .thumb {
        background: linear-gradient(140deg, var(--thumb-bg-a), var(--thumb-bg-b));
        border-radius: 18px;
        overflow: hidden;
      }

      .page--sub .thumb-mask,
      .page--leaf .thumb-mask {
        background: linear-gradient(180deg, var(--thumb-mask-top), var(--thumb-mask-bot));
      }

      .page--sub .btn,
      .page--leaf .btn,
      .page--sub .button,
      .page--leaf .button {
        background: rgba(255, 255, 255, 0.10);
        color: var(--text);
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 999px;
        backdrop-filter: blur(10px);
      }

      .page--sub .btn:hover,
      .page--leaf .btn:hover,
      .page--sub .button:hover,
      .page--leaf .button:hover {
        background: rgba(255, 255, 255, 0.14);
      }

      .page--sub .btn--primary,
      .page--leaf .btn--primary {
        background: var(--accent);
        color: var(--accent-text);
        border: 1px solid rgba(0, 0, 0, 0.08);
      }

      .page--sub .btn--primary:hover,
      .page--leaf .btn--primary:hover {
        filter: brightness(0.98);
      }

      .page--sub h1,
      .page--sub h2,
      .page--sub h3,
      .page--leaf h1,
      .page--leaf h2,
      .page--leaf h3 {
        color: var(--text);
      }

      .page--sub .subtitle,
      .page--leaf .subtitle {
        color: var(--text-soft);
      }
    </style>
  </head>
  <body class={bodyClass}>
    <a href="#content" class="skip-link">Skip to content</a>
    <div id="google_translate_element" aria-hidden="true"></div>
    <main id="content">
      <slot />
    </main>
    <footer class="site-footer">
      <nav aria-label="Footer links">
        <ul class="site-footer-links">
          {footerLinks.map((item) => (
            <li><a href={item.path}>{item.label}</a></li>
          ))}
        </ul>
      </nav>
    </footer>
    <script is:inline define:vars={{ lang }}>
      (() => {
        const normalizePath = (pathname) => {
          if (!pathname) return "/";
          return pathname.startsWith("/") ? pathname : `/${pathname}`;
        };
        const stripEsPrefix = (pathname) => {
          const normalized = normalizePath(pathname);
          if (normalized === "/es") return "/";
          if (normalized.startsWith("/es/")) {
            const stripped = normalized.slice(3);
            return stripped || "/";
          }
          return normalized;
        };
        const toLangPath = (pathname, targetLang) => {
          const base = stripEsPrefix(pathname);
          if (targetLang === "es") {
            return base === "/" ? "/es" : `/es${base}`;
          }
          return base;
        };
        const isSpanishPath = (pathname) => {
          const normalized = normalizePath(pathname);
          return normalized === "/es" || normalized.startsWith("/es/");
        };

        const normalizeLegacyLangQueryUrl = () => {
          const currentUrl = new URL(window.location.href);
          const queryLang = currentUrl.searchParams.get("lang");
          if (queryLang !== "es" && queryLang !== "en") {
            return false;
          }
          currentUrl.pathname = toLangPath(currentUrl.pathname, queryLang);
          currentUrl.searchParams.delete("lang");
          if (currentUrl.hash.startsWith("#googtrans")) {
            currentUrl.hash = "";
          }
          const nextUrl = currentUrl.toString();
          if (nextUrl === window.location.href) {
            return false;
          }
          window.location.replace(nextUrl);
          return true;
        };

        if (normalizeLegacyLangQueryUrl()) {
          return;
        }

        const enforceLegacyLangOnHistoryNav = () => {
          normalizeLegacyLangQueryUrl();
        };
        window.addEventListener("pageshow", enforceLegacyLangOnHistoryNav);
        window.addEventListener("popstate", () => {
          window.setTimeout(enforceLegacyLangOnHistoryNav, 0);
        });

        const activeLang = lang === "es" ? "es" : "en";
        document.documentElement.lang = activeLang;

        const hasTranslatedClass = () =>
          document.documentElement.classList.contains("translated-ltr") ||
          document.documentElement.classList.contains("translated-rtl") ||
          document.body.classList.contains("translated-ltr") ||
          document.body.classList.contains("translated-rtl");

        const cookieVariants = [location.hostname, `.${location.hostname}`];
        const setGoogTrans = (value, maxAge = 31536000) => {
          document.cookie = `googtrans=${value};path=/;max-age=${maxAge}`;
          for (const domain of cookieVariants) {
            document.cookie = `googtrans=${value};path=/;domain=${domain};max-age=${maxAge}`;
          }
        };
        const clearGoogTrans = () => {
          document.cookie = "googtrans=;path=/;max-age=0";
          for (const domain of cookieVariants) {
            document.cookie = `googtrans=;path=/;domain=${domain};max-age=0`;
          }
        };

        const initTranslate = () => {
          if (!window.google || !window.google.translate || !window.google.translate.TranslateElement) {
            return false;
          }
          new window.google.translate.TranslateElement(
            {
              pageLanguage: "en",
              includedLanguages: "en,es",
              autoDisplay: false,
            },
            "google_translate_element"
          );
          return true;
        };

        const ensureSpanishTranslate = () => {
          setGoogTrans("/en/es");
          setGoogTrans("/auto/es");
          if (initTranslate()) {
            return;
          }

          window.googleTranslateElementInit = initTranslate;
          const existingScript = document.querySelector("script[data-google-translate]");
          if (existingScript) {
            existingScript.addEventListener("load", initTranslate, { once: true });
            return;
          }

          const script = document.createElement("script");
          script.src = "https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit";
          script.async = true;
          script.defer = true;
          script.setAttribute("data-google-translate", "true");
          script.addEventListener("load", initTranslate, { once: true });
          document.head.appendChild(script);
        };
        const ES_RECOVERY_KEY = "visitkorea_es_recovery";
        const getEsRecoveryId = () => `${window.location.pathname}${window.location.search}`;
        const readEsRecoveryId = () => {
          try {
            return sessionStorage.getItem(ES_RECOVERY_KEY);
          } catch {
            return null;
          }
        };
        const writeEsRecoveryId = (value) => {
          try {
            sessionStorage.setItem(ES_RECOVERY_KEY, value);
          } catch {
            // Ignore session storage failures.
          }
        };
        const clearEsRecoveryId = () => {
          try {
            sessionStorage.removeItem(ES_RECOVERY_KEY);
          } catch {
            // Ignore session storage failures.
          }
        };
        const enforceSpanishRendering = () => {
          if (!isSpanishPath(window.location.pathname)) {
            return;
          }
          document.documentElement.lang = "es";
          ensureSpanishTranslate();
          window.setTimeout(() => {
            if (hasTranslatedClass()) {
              clearEsRecoveryId();
              return;
            }
            ensureSpanishTranslate();
            window.setTimeout(() => {
              if (hasTranslatedClass()) {
                clearEsRecoveryId();
                return;
              }
              const recoveryId = getEsRecoveryId();
              if (readEsRecoveryId() === recoveryId) {
                return;
              }
              writeEsRecoveryId(recoveryId);
              window.location.reload();
            }, 700);
          }, 260);
        };
        if (activeLang === "es") {
          enforceSpanishRendering();
          window.addEventListener("pageshow", () => {
            window.setTimeout(enforceSpanishRendering, 0);
          });
          window.addEventListener("popstate", () => {
            window.setTimeout(enforceSpanishRendering, 0);
          });
          return;
        }

        const cleanUrl = new URL(window.location.href);
        clearEsRecoveryId();
        clearGoogTrans();
        if (cleanUrl.hash.startsWith("#googtrans")) {
          cleanUrl.hash = "";
          window.history.replaceState({}, "", cleanUrl.toString());
        }
        if (hasTranslatedClass()) {
          cleanUrl.hash = "";
          window.location.replace(cleanUrl.toString());
        }
      })();
    </script>
    <script is:inline define:vars={{ gaMeasurementId }}>
      (() => {
        if (!gaMeasurementId) return;

        const send = (eventName, params = {}) => {
          if (typeof window.gtag !== "function") return;
          window.gtag("event", eventName, params);
        };

        const now = Date.now();
        const dayMs = 24 * 60 * 60 * 1000;
        const storageKey = "visitkorea_last_visit_ts";

        let previousVisit = null;
        try {
          const raw = window.localStorage.getItem(storageKey);
          const parsed = raw ? Number(raw) : NaN;
          previousVisit = Number.isFinite(parsed) ? parsed : null;
        } catch {
          previousVisit = null;
        }

        const daysSinceLast = previousVisit ? Math.floor((now - previousVisit) / dayMs) : -1;
        const within7d = previousVisit !== null && daysSinceLast >= 0 && daysSinceLast <= 7;

        send("visit_recency", {
          page_path: window.location.pathname,
          days_since_last: daysSinceLast,
          within_7d: within7d ? "yes" : "no",
        });

        try {
          window.localStorage.setItem(storageKey, String(now));
        } catch {
          // Ignore localStorage failures in private mode.
        }

        const cardLinks = document.querySelectorAll(".card[data-card-link]");
        if (cardLinks.length > 0) {
          send("card_impression", {
            page_path: window.location.pathname,
            card_count: cardLinks.length,
          });
        }

        const isInternalHttpLink = (url) =>
          (url.protocol === "http:" || url.protocol === "https:") && url.origin === window.location.origin;

        const getKpiSection = (anchor) =>
          anchor.getAttribute("data-kpi-section") ||
          anchor.closest("[data-kpi-section]")?.getAttribute("data-kpi-section") ||
          (anchor.closest(".leaf-tools") ? "leaf_tools" : "main_content");

        document.addEventListener(
          "click",
          (event) => {
            const target = event.target;
            if (!(target instanceof Element)) return;
            const anchor = target.closest("a[href]");
            if (!(anchor instanceof HTMLAnchorElement)) return;

            const href = anchor.getAttribute("href");
            if (!href || href.startsWith("#") || href.startsWith("mailto:") || href.startsWith("tel:")) return;

            const next = new URL(anchor.href, window.location.origin);
            if (!isInternalHttpLink(next)) return;

            const currentPath = `${window.location.pathname}${window.location.search}`;
            const targetPath = `${next.pathname}${next.search}`;
            if (targetPath === currentPath) return;

            const linkText = (anchor.textContent || "").trim().slice(0, 90);
            const section = getKpiSection(anchor);

            send("internal_navigation_click", {
              from_path: window.location.pathname,
              to_path: next.pathname,
              link_text: linkText || "(empty)",
              section,
            });

            if (anchor.matches(".card[data-card-link]")) {
              send("card_click", {
                from_path: window.location.pathname,
                card_title: anchor.getAttribute("data-card-title") || linkText || "(untitled)",
                to_path: next.pathname,
                section,
              });
            }

            if (
              next.pathname.includes("/latest-travel-updates-for-korea") ||
              next.pathname.includes("/korea-now-and-more")
            ) {
              send("weekly_hub_click", {
                from_path: window.location.pathname,
                to_path: next.pathname,
                section,
              });
            }
          },
          true
        );
      })();
    </script>
  </body>
</html>
