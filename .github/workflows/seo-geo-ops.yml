name: SEO GEO Daily Ops

  on:
    workflow_dispatch:
    schedule:
      - cron: "17 2 * * *"

  jobs:
    submit-sitemap:
      runs-on: ubuntu-latest
      if: ${{ vars.GSC_SITE_URL != '' && secrets.GSC_SERVICE_ACCOUNT_KEY_JSON != '' }}
      permissions:
        contents: read

      steps:
        - name: Authenticate to Google
          id: auth
          uses: google-github-actions/auth@v2
          with:
            credentials_json: ${{ secrets.GSC_SERVICE_ACCOUNT_KEY_JSON }}
            token_format: access_token
            scopes: https://www.googleapis.com/auth/webmasters

        - name: Submit sitemap to Search Console
          env:
            GSC_SITE_URL: ${{ vars.GSC_SITE_URL }}
            GSC_SITEMAP_URL: ${{ vars.GSC_SITEMAP_URL }}
            ACCESS_TOKEN: ${{ steps.auth.outputs.access_token }}
          run: |
            python3 - <<'PY'
            import os, urllib.parse, urllib.request

            site = (os.environ.get("GSC_SITE_URL") or "").strip()
            if not site:
                raise SystemExit("GSC_SITE_URL is empty")

            sitemap = (os.environ.get("GSC_SITEMAP_URL") or "").strip()
            if not sitemap:
                if site.startswith("sc-domain:"):
                    raise SystemExit("Set GSC_SITEMAP_URL when using sc-domain property.")
                sitemap = urllib.parse.urljoin(site if site.endswith("/") else site + "/", "sitemap.xml")

            url = (
                "https://www.googleapis.com/webmasters/v3/sites/"
                + urllib.parse.quote(site, safe="")
                + "/sitemaps/"
                + urllib.parse.quote(sitemap, safe="")
            )

            req = urllib.request.Request(
                url,
                method="PUT",
                headers={"Authorization": f"Bearer {os.environ['ACCESS_TOKEN']}"},
            )

            with urllib.request.urlopen(req) as r:
                print(f"[gsc-submit] status={r.status}")
            print(f"[gsc-submit] submitted {sitemap} for {site}")
            PY
