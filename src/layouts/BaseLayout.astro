---
import { withLang, type SupportedLang } from "../lib/i18n";
import {
  absoluteUrl,
  DEFAULT_OG_IMAGE_ALT,
  DEFAULT_OG_IMAGE_PATH,
  SITE_NAME,
} from "../lib/site";

type BreadcrumbItem = {
  label: string;
  path: string;
};

const {
  title = "Visit Korea Planner",
  description = "Practical travel guidance for foreigners visiting Korea.",
  bodyClass = "",
  lang = "en",
  canonicalUrl = absoluteUrl("/"),
  alternateEnUrl = absoluteUrl("/"),
  alternateEsUrl = absoluteUrl(withLang("/", "es")),
  breadcrumbs = [],
  noindex = false,
  ogImage = absoluteUrl(DEFAULT_OG_IMAGE_PATH),
  ogImageAlt = DEFAULT_OG_IMAGE_ALT,
} = Astro.props as {
  title?: string;
  description?: string;
  bodyClass?: string;
  lang?: SupportedLang;
  canonicalUrl?: string;
  alternateEnUrl?: string;
  alternateEsUrl?: string;
  breadcrumbs?: BreadcrumbItem[];
  noindex?: boolean;
  ogImage?: string;
  ogImageAlt?: string;
};

const robotsContent = noindex
  ? "noindex, nofollow"
  : "index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1";
const locale = lang === "es" ? "es_ES" : "en_US";
const alternateLocale = lang === "es" ? "en_US" : "es_ES";
const siteName = lang === "es" ? "Planificador de viaje a Corea" : SITE_NAME;
const homeLabel = lang === "es" ? "Inicio" : "Home";
const localizedHomePath = withLang("/", lang);

const breadcrumbTrail = [{ label: homeLabel, path: localizedHomePath }, ...breadcrumbs].reduce(
  (acc, item) => {
    if (!item?.label || !item?.path) return acc;
    if (acc.some((existing) => existing.path === item.path)) return acc;
    acc.push(item);
    return acc;
  },
  [] as BreadcrumbItem[]
);

const schemaGraph: Record<string, unknown>[] = [
  {
    "@type": "WebSite",
    "@id": `${absoluteUrl("/")}#website`,
    url: absoluteUrl("/"),
    name: siteName,
    inLanguage: lang,
  },
  {
    "@type": "WebPage",
    "@id": `${canonicalUrl}#webpage`,
    url: canonicalUrl,
    name: title,
    description,
    inLanguage: lang,
    isPartOf: { "@id": `${absoluteUrl("/")}#website` },
  },
];

if (breadcrumbTrail.length > 1) {
  schemaGraph.push({
    "@type": "BreadcrumbList",
    "@id": `${canonicalUrl}#breadcrumb`,
    itemListElement: breadcrumbTrail.map((item, index) => ({
      "@type": "ListItem",
      position: index + 1,
      name: item.label,
      item: absoluteUrl(item.path),
    })),
  });
}

const schemaJson = JSON.stringify({
  "@context": "https://schema.org",
  "@graph": schemaGraph,
});

---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <meta name="theme-color" content="#120E0B" />
    <meta name="robots" content={robotsContent} />
    <meta name="googlebot" content={robotsContent} />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <meta name="author" content={siteName} />
    <link rel="icon" href="/favicon.ico" />
    <link rel="sitemap" type="application/xml" href={absoluteUrl("/sitemap.xml")} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;600;700&family=Work+Sans:wght@300;400;500;600&display=swap"
    />
    <meta name="description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:alt" content={ogImageAlt} />
    <meta property="og:locale" content={locale} />
    <meta property="og:locale:alternate" content={alternateLocale} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    <link rel="canonical" href={canonicalUrl} />
    <link rel="alternate" hreflang="en" href={alternateEnUrl} />
    <link rel="alternate" hreflang="es" href={alternateEsUrl} />
    <link rel="alternate" hreflang="x-default" href={alternateEnUrl} />
    <script type="application/ld+json" set:html={schemaJson} />
    <title>{title}</title>
    <style>
      :root {
        color-scheme: dark;
        --bg-0: #120e0b;
        --bg-1: #1a120e;
        --bg-2: #0f0b09;

        --text-strong: #f7f3ee;
        --text-soft: #e7e2da;
        --text-muted: #c9c1b6;

        --ink-strong: #171412;
        --ink-soft: #4a433c;

        --paper: #f5f0e8;
        --paper-2: #efe7dc;

        --border-dark: rgba(255, 255, 255, 0.1);
        --border-paper: rgba(23, 20, 18, 0.08);

        --shadow-1: 0 10px 24px rgba(0, 0, 0, 0.28);
        --shadow-2: 0 18px 44px rgba(0, 0, 0, 0.34);
        --radius-xl: 22px;

        --accent: #7c5cff;
        --accent-hover: #6a4ef0;

        --text: var(--text-strong);
        --muted: var(--text-muted);
        --ink: var(--ink-strong);
        --ring: rgba(124, 92, 255, 0.22);
        --shadow: var(--shadow-1);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Work Sans", system-ui, sans-serif;
        color: var(--text-soft);
        background:
          radial-gradient(1200px 600px at 20% -10%, rgba(255, 255, 255, 0.06), transparent 55%),
          linear-gradient(180deg, var(--bg-1), var(--bg-2));
        min-height: 100vh;
      }

      body.page--sub {
        background:
          radial-gradient(1200px 600px at 20% -10%, rgba(255, 255, 255, 0.06), transparent 55%),
          linear-gradient(180deg, var(--bg-1), var(--bg-2));
      }

      body.page--leaf {
        background:
          radial-gradient(1200px 600px at 20% -10%, rgba(255, 255, 255, 0.06), transparent 55%),
          linear-gradient(180deg, var(--bg-1), var(--bg-2));
      }

      body.home-bg {
        background:
          radial-gradient(1200px 600px at 20% -10%, rgba(255, 255, 255, 0.06), transparent 55%),
          linear-gradient(180deg, rgba(18, 14, 11, 0.3), rgba(18, 14, 11, 0.5)),
          linear-gradient(180deg, var(--bg-1), var(--bg-2)),
          url("/hero.webp");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
      }

      body.page--sub main {
        background: transparent;
        border-radius: 0;
        border: none;
        box-shadow: none;
        padding: 48px 36px 80px;
      }

      body.page--leaf main {
        background: transparent;
        border-radius: 0;
        border: none;
        box-shadow: none;
        padding: 48px 36px 80px;
      }

      @media (max-width: 720px) {
        body.page--sub main,
        body.page--leaf main {
          padding: 32px 18px 64px;
        }
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      h1,
      h2,
      h3 {
        color: var(--text-strong);
      }

      p,
      li {
        color: var(--text-soft);
      }

      .small,
      .muted {
        color: var(--text-muted);
      }

      main {
        width: min(1100px, 92vw);
        margin: 0 auto;
        padding: 48px 0 80px;
      }

      .skip-link {
        position: absolute;
        left: -999px;
        top: 0;
      }

      .skip-link:focus {
        left: 16px;
        top: 16px;
        background: #fff;
        padding: 8px 12px;
        border-radius: 999px;
        box-shadow: var(--shadow);
      }

      @media (max-width: 720px) {
        main {
          padding: 32px 0 64px;
        }
      }

      #google_translate_element {
        position: absolute;
        width: 0;
        height: 0;
        overflow: hidden;
        opacity: 0;
        pointer-events: none;
      }

    </style>
  </head>
  <body class={bodyClass}>
    <a href="#content" class="skip-link">Skip to content</a>
    <div id="google_translate_element" aria-hidden="true"></div>
    <main id="content">
      <slot />
    </main>
    <script is:inline>
      (() => {
        const STORAGE_KEY = "visitkorea_lang_pref";
        const readLangPref = () => {
          try {
            const stored = sessionStorage.getItem(STORAGE_KEY);
            return stored === "es" || stored === "en" ? stored : null;
          } catch {
            return null;
          }
        };
        const writeLangPref = (value) => {
          try {
            sessionStorage.setItem(STORAGE_KEY, value);
          } catch {
            // Ignore storage failures (privacy mode, blocked storage, etc.)
          }
        };
        const getNavigationType = () => {
          const navEntry = performance.getEntriesByType("navigation")[0];
          if (!navEntry || typeof navEntry !== "object" || !("type" in navEntry)) {
            return "navigate";
          }
          return navEntry.type;
        };
        const hasSpanishCookie = () =>
          /(?:^|;\s*)googtrans=\/(?:en|auto)\/es(?:;|$)/.test(document.cookie);
        const hasTranslatedClass = () =>
          document.documentElement.classList.contains("translated-ltr") ||
          document.documentElement.classList.contains("translated-rtl") ||
          document.body.classList.contains("translated-ltr") ||
          document.body.classList.contains("translated-rtl");
        const hasSpanishGoogTransState = () =>
          hasSpanishCookie() || window.location.hash.startsWith("#googtrans");

        const cookieVariants = [location.hostname, `.${location.hostname}`];
        const setGoogTrans = (value, maxAge = 31536000) => {
          document.cookie = `googtrans=${value};path=/;max-age=${maxAge}`;
          for (const domain of cookieVariants) {
            document.cookie = `googtrans=${value};path=/;domain=${domain};max-age=${maxAge}`;
          }
        };
        const clearGoogTrans = () => {
          document.cookie = "googtrans=;path=/;max-age=0";
          for (const domain of cookieVariants) {
            document.cookie = `googtrans=;path=/;domain=${domain};max-age=0`;
          }
        };

        const initTranslate = () => {
          if (!window.google || !window.google.translate || !window.google.translate.TranslateElement) {
            return false;
          }
          new window.google.translate.TranslateElement(
            {
              pageLanguage: "en",
              includedLanguages: "en,es",
              autoDisplay: false,
            },
            "google_translate_element"
          );
          return true;
        };

        const ensureSpanishTranslate = () => {
          setGoogTrans("/en/es");
          setGoogTrans("/auto/es");
          if (initTranslate()) {
            return;
          }

          window.googleTranslateElementInit = initTranslate;
          const existingScript = document.querySelector("script[data-google-translate]");
          if (existingScript) {
            existingScript.addEventListener("load", initTranslate, { once: true });
            return;
          }

          const script = document.createElement("script");
          script.src = "https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit";
          script.async = true;
          script.defer = true;
          script.setAttribute("data-google-translate", "true");
          script.addEventListener("load", initTranslate, { once: true });
          document.head.appendChild(script);
        };

        const LANG_STATE_KEY = "visitkoreaLang";
        const readHistoryLang = () => {
          const state = window.history.state;
          if (!state || typeof state !== "object") return null;
          const value = state[LANG_STATE_KEY];
          return value === "es" || value === "en" ? value : null;
        };
        const replaceHistoryWithLang = (nextUrl, nextLang) => {
          const previousState =
            window.history.state && typeof window.history.state === "object"
              ? window.history.state
              : {};
          window.history.replaceState({ ...previousState, [LANG_STATE_KEY]: nextLang }, "", nextUrl.toString());
        };

        const normalizeEnQuery = () => {
          const currentUrl = new URL(window.location.href);
          if (currentUrl.searchParams.get("lang") === "en") {
            currentUrl.searchParams.delete("lang");
            replaceHistoryWithLang(currentUrl, "en");
          }
        };

        const applyEnglishState = () => {
          document.documentElement.lang = "en";
          const cleanUrl = new URL(window.location.href);
          const needsEnglishReset = hasSpanishGoogTransState() || hasTranslatedClass();
          clearGoogTrans();
          if (cleanUrl.searchParams.get("lang") === "en") {
            cleanUrl.searchParams.delete("lang");
          }
          if (cleanUrl.hash.startsWith("#googtrans")) {
            cleanUrl.hash = "";
            replaceHistoryWithLang(cleanUrl, "en");
          }
          if (needsEnglishReset) {
            cleanUrl.hash = "";
            cleanUrl.searchParams.delete("lang");
            window.location.replace(cleanUrl.toString());
            return;
          }
          replaceHistoryWithLang(cleanUrl, "en");
        };

        const applySpanishState = () => {
          const currentUrl = new URL(window.location.href);
          if (currentUrl.searchParams.get("lang") !== "es") {
            currentUrl.searchParams.set("lang", "es");
          }
          replaceHistoryWithLang(currentUrl, "es");
          document.documentElement.lang = "es";
          ensureSpanishTranslate();
          window.setTimeout(() => {
            if (!hasTranslatedClass()) {
              ensureSpanishTranslate();
            }
          }, 350);
        };

        const resolveActiveLang = () => {
          normalizeEnQuery();
          const currentUrl = new URL(window.location.href);
          const queryLang = currentUrl.searchParams.get("lang");
          const storedLang = readLangPref();
          const historyLang = readHistoryLang();
          const navType = getNavigationType();
          const isInternalReferrer = document.referrer.startsWith(window.location.origin);
          const fromSpanishInternalReferrer = isInternalReferrer && /[?&]lang=es(?:&|$)/.test(document.referrer);
          const hasSpanishSignal =
            queryLang === "es" ||
            historyLang === "es" ||
            (storedLang === "es" && (navType === "back_forward" || isInternalReferrer || fromSpanishInternalReferrer));
          const shouldKeepSpanish =
            queryLang !== "es" &&
            hasSpanishSignal;

          if (queryLang === "es" || shouldKeepSpanish) {
            writeLangPref("es");
            return "es";
          }

          const isDirectEntry = !isInternalReferrer && navType !== "back_forward";
          if (isDirectEntry || queryLang === "en" || historyLang === "en") {
            writeLangPref("en");
            return "en";
          }

          writeLangPref("en");
          return "en";
        };

        const syncLanguageOnHistoryNavigation = () => {
          const resolvedLang = resolveActiveLang();
          if (resolvedLang === "es") {
            applySpanishState();
            return;
          }
          applyEnglishState();
        };

        const activeLang = resolveActiveLang();
        if (activeLang === "es") {
          applySpanishState();
        } else {
          applyEnglishState();
        }

        window.addEventListener("pageshow", (event) => {
          if (event.persisted) {
            syncLanguageOnHistoryNavigation();
            return;
          }
          const pageUrl = new URL(window.location.href);
          if (pageUrl.searchParams.get("lang") === "es") {
            applySpanishState();
          }
        });

        window.addEventListener("popstate", () => {
          window.setTimeout(syncLanguageOnHistoryNavigation, 0);
        });
      })();
    </script>
  </body>
</html>
