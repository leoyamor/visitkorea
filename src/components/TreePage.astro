---
import AdSenseSafeSlot from "./AdSenseSafeSlot.astro";
import { findNodeBySegments, siteTree, type TreeNode } from "../data/siteTree";
import { getEditorialMeta } from "../lib/editorial";
import { getHubFaqItems, getHubQuickSummary } from "../lib/hubFaq";
import { getLeafFaqItems } from "../lib/leafFaq";
import { getHomeLeafTickerItems } from "../lib/leafUpdates";
import type { SupportedLang } from "../lib/i18n";
import { withLang } from "../lib/i18n";

type Props = {
  node: TreeNode;
  segments: string[];
  parentPath: string;
  isHome?: boolean;
  breadcrumbs?: { label: string; path: string }[];
  lang?: SupportedLang;
};

const { node, segments, parentPath, isHome = false, breadcrumbs = [], lang = "en" } =
  Astro.props as Props;

const basePath = segments.length ? `/${segments.join("/")}` : "";
const children = node.children ?? [];
const hasChildren = children.length > 0;
const FEEDBACK_FORM_URL =
  "https://docs.google.com/forms/d/e/1FAIpQLSf93xq-USyR4GWOJxyEjMaY8z4VidA7_zvLons-Xsm1tZ97gw/viewform?usp=publish-editor";
const t = {
  en: {
    language: "Language",
    english: "English",
    spanish: "Spanish",
    plannerName: "Visit Korea Planner",
    homeTitle: "Travel Korea with Clarity, Not Overload",
    homeLead:
      "Clear, practical answers plus timely travel updates and 5-minute culture tips for every stage of your trip.",
    back: "Back",
    home: "Home",
    backAria: "Back to previous page",
    homeAria: "Go to home",
    nextSet: "Explore the next set of guides.",
    startHere: "Start here",
    pickSub: "Pick a sub page",
    quickAnswer: "Quick answer",
    leafQuickSupport:
      "Use the key points below, then run the checklist to lock your plan in about 5 minutes.",
    leafFaqTitle: "Quick FAQ",
    hubFaqTitle: "Top questions",
    homeSectionDesc: "Start with a category, then come back for update checks and Korea insights.",
    subSectionDesc: "Each card opens a focused guide.",
    quickFallback: "Here is the short description, with more detail to be added later.",
    cardFallback: "Short summary coming soon.",
    guidePreparing: "This guide is being prepared.",
    identity: "This site helps you decide what fits your trip — not just list information.",
    homeCtaTitle: "Not sure where to go next?",
    homeCtaDesc: "Start with these core guides, then check update cards before key travel decisions.",
    pillDays: "7 Days in Korea",
    pillSim: "SIM or eSIM?",
    pillSubway: "Using the Subway",
    pillCityFit: "Which City Fits You Best?",
    pillNowMore: "Korea Now & More",
    nextPrefix: "Next",
    nextDecision: "Next decision",
    nextDecisionHint: "Best next step after this page.",
    returnCheckpoints: "Return checkpoints",
    quickChecklist: "Quick checklist",
    checklistHint:
      "No login needed. Tick what you completed, then screenshot or bookmark this page for later.",
    bookmarkTip: "Pro tip: Save this page to your home screen for quick access during your trip.",
    returnLatest: "Latest Travel Updates",
    returnNowMore: "Korea Now & More",
    returnThisWeek: "This Week in Korea",
    updateTickerLabel: "What changed this week",
    updatedLabel: "Last updated",
    sourceNote: "For final booking decisions, always verify with official sources.",
    nextFallback: "Latest Travel Updates for Korea",
    feedbackEyebrow: "Help us improve",
    feedbackTitle: "What should we improve for travelers?",
    feedbackDesc:
      "Tell us what felt unclear or missing. It takes about 2 minutes and helps us make this guide easier to use.",
    feedbackButton: "Open feedback form",
    feedbackNote: "Opens Google Form in a new tab.",
  },
  es: {
    language: "Idioma",
    english: "Ingles",
    spanish: "Espanol",
    plannerName: "Visit Korea Planner",
    homeTitle: "Viaja por Corea con claridad, sin sobrecarga",
    homeLead:
      "Respuestas claras y practicas, mas actualizaciones de viaje oportunas y consejos culturales de 5 minutos para cada etapa de tu viaje.",
    back: "Atras",
    home: "Inicio",
    backAria: "Volver a la pagina anterior",
    homeAria: "Ir al inicio",
    nextSet: "Explora el siguiente grupo de guias.",
    startHere: "Empieza aqui",
    pickSub: "Elige una subpagina",
    quickAnswer: "Respuesta rapida",
    leafQuickSupport:
      "Usa los puntos clave de abajo y luego la lista rapida para cerrar tu plan en unos 5 minutos.",
    leafFaqTitle: "FAQ rapido",
    hubFaqTitle: "Preguntas clave",
    homeSectionDesc:
      "Empieza con una categoria y vuelve para revisar actualizaciones y conocer mejor Corea.",
    subSectionDesc: "Cada tarjeta abre una guia enfocada.",
    quickFallback: "Aqui tienes una descripcion breve; agregaremos mas detalle mas adelante.",
    cardFallback: "Resumen breve proximamente.",
    guidePreparing: "Esta guia se esta preparando.",
    identity: "Este sitio te ayuda a decidir que encaja con tu viaje, no solo a listar informacion.",
    homeCtaTitle: "No sabes adonde ir despues?",
    homeCtaDesc:
      "Empieza con estas guias clave y revisa las tarjetas de actualizacion antes de decisiones importantes.",
    pillDays: "7 dias en Corea",
    pillSim: "SIM o eSIM?",
    pillSubway: "Como usar el metro",
    pillCityFit: "Que ciudad te queda mejor?",
    pillNowMore: "Korea Now & More",
    nextPrefix: "Siguiente",
    nextDecision: "Siguiente decision",
    nextDecisionHint: "Mejor siguiente paso despues de esta pagina.",
    returnCheckpoints: "Puntos de regreso",
    quickChecklist: "Lista rapida",
    checklistHint:
      "No necesitas iniciar sesion. Marca lo que completaste y luego guarda una captura o un marcador para despues.",
    bookmarkTip: "Consejo: guarda esta pagina en tu pantalla de inicio para acceder rapido durante tu viaje.",
    returnLatest: "Ultimas actualizaciones de viaje",
    returnNowMore: "Korea Now & More",
    returnThisWeek: "This Week in Korea",
    updateTickerLabel: "Novedades de esta semana",
    updatedLabel: "Actualizado",
    sourceNote: "Para decisiones finales de reserva, verifica siempre en fuentes oficiales.",
    nextFallback: "Ultimas actualizaciones de viaje para Corea",
    feedbackEyebrow: "Ayudanos a mejorar",
    feedbackTitle: "Que deberiamos mejorar para los viajeros?",
    feedbackDesc:
      "Cuentanos que fue poco claro o que falto. Toma unos 2 minutos y nos ayuda a hacer esta guia mas facil de usar.",
    feedbackButton: "Abrir formulario de comentarios",
    feedbackNote: "Abre el formulario de Google en una pestana nueva.",
  },
}[lang];

const getInitials = (title: string) => {
  const words = title.replace(/[?]/g, "").split(" ").filter(Boolean);
  const letters = words.map((word) => word[0]);
  return letters.slice(0, 2).join("").toUpperCase();
};

const iconMap: Record<string, string> = {
  calendar:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 2v3M17 2v3M3.5 9h17M5 6h14a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2Z"/><path d="M8 12h3M13 12h3M8 16h3M13 16h3"/></svg>',
  compass:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="8"/><path d="M14.8 9.2 9.7 11l-1.5 4.3 5.1-1.8 1.5-4.3Z"/><circle cx="12" cy="12" r="1.4"/></svg>',
  spark:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3 9.7 8.3 4 10l5.7 1.7L12 17l2.3-5.3L20 10l-5.7-1.7L12 3Z"/></svg>',
  city:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 20V7l6-3v16M14 20V4l6 3v13"/><path d="M7.5 10h2M7.5 13.5h2M16.5 10h2M16.5 13.5h2"/></svg>',
  beach:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 20c4-4 12-4 16 0"/><path d="M6 13l8-6 2 3-8 6-2-3Z"/><path d="M14 7 11 3"/></svg>',
  island:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 20c2-3 6-4 9-4s7 1 9 4"/><path d="M8 14c1-3 3-5 6-5"/><path d="M14 9c1-2 2-3 3-3"/><circle cx="8" cy="7" r="1.5"/></svg>',
  temple:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 11h18M5 11l7-5 7 5"/><path d="M6 11v7M18 11v7M4 18h16"/></svg>',
  bowl:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 13c0 4 3.6 7 8 7s8-3 8-7H4Z"/><path d="M7 6c0 2 2 2 2 4M12 5c0 2 2 2 2 4M17 6c0 2-2 2-2 4"/></svg>',
  leaf:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 18c7 0 12-5 14-12-7 2-12 7-12 14 0 1.5 0 2 0 2"/><path d="M8 14c2 0 4-2 6-4"/></svg>',
  pin:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 21s6-6 6-11a6 6 0 1 0-12 0c0 5 6 11 6 11Z"/><circle cx="12" cy="10" r="2"/></svg>',
  chili:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15 7c-2-1-5 0-7 3-2 3-2 7 1 8 3 1 7-1 9-4 2-3 1-6-3-7Z"/><path d="M14 6c1-2 3-3 5-2"/></svg>',
  train:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 17V7a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v10"/><path d="M6 17h12l-2 3M8 20l-2-3"/><circle cx="9" cy="12" r="1.5"/><circle cx="15" cy="12" r="1.5"/></svg>',
  bus:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="5" y="4" width="14" height="14" rx="3"/><path d="M7 9h10M7 12h10"/><circle cx="8.5" cy="18" r="1.5"/><circle cx="15.5" cy="18" r="1.5"/></svg>',
  taxi:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 11 8 6h8l2 5"/><rect x="4" y="11" width="16" height="7" rx="2"/><circle cx="8" cy="18" r="1.5"/><circle cx="16" cy="18" r="1.5"/></svg>',
  car:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 14 6 8h12l2 6"/><rect x="3" y="14" width="18" height="5" rx="2"/><circle cx="7.5" cy="19" r="1.5"/><circle cx="16.5" cy="19" r="1.5"/></svg>',
  card:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="4" y="6" width="16" height="12" rx="2"/><path d="M4 10h16M7 14h5"/></svg>',
  wallet:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="3" y="7" width="18" height="12" rx="3"/><path d="M16 11h5v4h-5a2 2 0 0 1 0-4Z"/></svg>',
  transfer:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 7h10l-2-2M17 7l-2 2"/><path d="M17 17H7l2 2M7 17l2-2"/></svg>',
  bed:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="4" y="10" width="16" height="7" rx="2"/><path d="M6 10V8a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M4 17v3M20 17v3"/></svg>',
  sim:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 4h6l4 4v12H8V4Z"/><path d="M10 9h4M10 12h4M10 15h4"/></svg>',
  shield:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3 19 6v6c0 5-4 8-7 9-3-1-7-4-7-9V6l7-3Z"/><path d="m9 12 2 2 4-4"/></svg>',
  alert:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="m12 3 9 16H3L12 3Z"/><path d="M12 9v4M12 17h.01"/></svg>',
  cloud:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 18h10a4 4 0 0 0 0-8 5 5 0 0 0-9.6-1.6A3.6 3.6 0 0 0 7 18Z"/></svg>',
  passport:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="6" y="4" width="12" height="16" rx="2"/><circle cx="12" cy="11" r="2.5"/><path d="M9 16h6"/></svg>',
  hand:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 11V6a1.5 1.5 0 0 1 3 0v5"/><path d="M11 11V5a1.5 1.5 0 0 1 3 0v6"/><path d="M14 11V6a1.5 1.5 0 0 1 3 0v8a6 6 0 0 1-6 6H9a4 4 0 0 1-4-4v-5a2 2 0 0 1 4 0v1"/></svg>',
  checklist:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="6" y="4" width="12" height="16" rx="2"/><path d="m9 9 1.5 1.5L13 8"/><path d="M9 13h6M9 16h6"/></svg>',
  plane:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M2 13 22 11 2 9 2 13Z"/><path d="M10 11 6 4M10 13 6 20"/></svg>',
  bag:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="5" y="7" width="14" height="13" rx="2"/><path d="M9 7V6a3 3 0 0 1 6 0v1"/></svg>',
  receipt:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 3h12v18l-2-1-2 1-2-1-2 1-2-1-2 1V3Z"/><path d="M9 8h6M9 12h6M9 16h4"/></svg>',
  tag:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M10 4H4v6l8 8 6-6-8-8Z"/><circle cx="7" cy="7" r="1.5"/></svg>',
  route:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M19 21a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M7 5h5a4 4 0 0 1 0 8H9a4 4 0 0 0 0 8h5"/></svg>',
};

const toneMap: Record<string, string> = {
  calendar: "sunset",
  compass: "sky",
  spark: "gold",
  city: "slate",
  beach: "sea",
  island: "sea",
  temple: "sand",
  bowl: "spice",
  leaf: "leaf",
  pin: "rose",
  chili: "chili",
  train: "steel",
  bus: "steel",
  taxi: "amber",
  car: "steel",
  card: "mint",
  wallet: "mint",
  transfer: "steel",
  bed: "lilac",
  sim: "sky",
  shield: "steel",
  alert: "chili",
  passport: "slate",
  hand: "sand",
  checklist: "sky",
  plane: "sky",
  bag: "gold",
  receipt: "mint",
  tag: "gold",
  route: "steel",
};

const renderIcon = (key?: string) => {
  if (!key) return null;
  return iconMap[key] ?? null;
};

const escapeHtml = (value: string) =>
  value.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

const keywordLinks: Record<string, string> = {
  "K-ETA": "https://www.k-eta.go.kr",
  "Korean Immigration Service": "https://www.immigration.go.kr",
  "Visit Korea": "https://english.visitkorea.or.kr",
  "Korail": "https://www.letskorail.com",
  "Incheon International Airport": "https://www.airport.kr",
  "Seoul Metro": "https://www.seoulmetro.co.kr",
  "Korea Meteorological Administration": "https://www.weather.go.kr",
  "Seoul Tourism Organization": "https://english.visitseoul.net",
  "Busan Tourism Organization": "https://english.busan.go.kr",
  "Jeju Tourism Organization": "https://english.visitjeju.net",
  "Gyeongju Tourism": "https://www.gyeongju.go.kr",
  "Ministry of Foreign Affairs": "https://www.mofa.go.kr",
  "Global Tax Free Korea": "https://www.globaltaxfree.com",
  "Korea Customs Service": "https://www.customs.go.kr",
  ...(lang === "en"
    ? {
        "travel insurance for Korea": "/travel-basics/travel-insurance-for-korea/",
        "hospital costs in Korea": "/travel-basics/travel-insurance-for-korea/",
      }
    : {
        "seguro de viaje para Corea": "/es/travel-basics/travel-insurance-for-korea/",
        "costos hospitalarios en Corea": "/es/travel-basics/travel-insurance-for-korea/",
      }),
};

const getUrlLabel = (url: string) => {
  try {
    const { hostname } = new URL(url);
    return hostname.replace(/^www\./, "");
  } catch {
    return url;
  }
};

const isAbsoluteHttpUrl = (url: string) => /^https?:\/\//i.test(url);
const EMPTY_EXCLUDED_KEYWORDS = new Set<string>();
const KEYWORD_LINK_EXCLUSIONS_BY_PATH: Record<string, Set<string>> = {
  "/plan-your-trip/7-days-in-korea": new Set([
    "K-ETA",
  ]),
  "/getting-around-korea/is-getting-around-hard": new Set([
    "Korail",
    "Incheon International Airport",
  ]),
  "/latest-travel-updates-for-korea": new Set([
    "K-ETA",
    "Incheon International Airport",
    "Korail",
    "Korea Meteorological Administration",
    "Seoul Tourism Organization",
    "Busan Tourism Organization",
    "Jeju Tourism Organization",
    "Gyeongju Tourism",
    "Ministry of Foreign Affairs",
    "Global Tax Free Korea",
    "Korea Customs Service",
  ]),
};

const linkify = (text: string) => {
  const excludedKeywords = KEYWORD_LINK_EXCLUSIONS_BY_PATH[basePath] ?? EMPTY_EXCLUDED_KEYWORDS;
  const escaped = escapeHtml(text);

  // Turn "Label: https://example.com" into a link on "Label" only.
  const withNamedUrlLinks = escaped.replace(
    /(^|[\n\r])([^:\n]+):\s*(https?:\/\/[^\s]+)/gm,
    (_match, prefix: string, label: string, url: string) => {
      const safeUrl = url.replace(/"/g, "&quot;");
      return `${prefix}<a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${label.trim()}</a>`;
    }
  );

  const withUrls = withNamedUrlLinks
    .split(/(<a\b[^>]*>.*?<\/a>)/g)
    .map((part) => {
      if (part.startsWith("<a")) return part;
      return part.replace(/(https?:\/\/[^\s]+)/g, (url) => {
        const safeUrl = url.replace(/"/g, "&quot;");
        const label = getUrlLabel(url);
        return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${label}</a>`;
      });
    })
    .join("");

  const parts = withUrls.split(/(<a\b[^>]*>.*?<\/a>)/g);
  return parts
    .map((part, index) => {
      if (part.startsWith("<a")) return part;
      // For "Name: <url>" patterns, keep the label plain text and link only the URL.
      const nextPart = parts[index + 1] ?? "";
      if (nextPart.startsWith("<a") && /:\s*$/.test(part)) {
        return part;
      }
      let next = part;
      for (const [keyword, href] of Object.entries(keywordLinks)) {
        if (excludedKeywords.has(keyword)) continue;
        const safeHref = href.replace(/"/g, "&quot;");
        const externalAttrs = isAbsoluteHttpUrl(href)
          ? ` target="_blank" rel="noopener noreferrer"`
          : "";
        // Keep "Name: https://..." patterns readable by linking only the URL label.
        const pattern = new RegExp(
          `\\b${keyword.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")}\\b(?!\\s*:)`,
          "g"
        );
        next = next.replace(
          pattern,
          `<a href="${safeHref}"${externalAttrs}>${keyword}</a>`
        );
      }
      return next;
    })
    .join("");
};

const getTone = (key?: string) => {
  if (!key) return "default";
  return toneMap[key] ?? "default";
};

const toDataUri = (svg: string) =>
  `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;

const imageSvgs: Record<string, string> = {
  planning: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#f2d2a2"/>
          <stop offset="100%" stop-color="#f7b267"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <rect x="52" y="48" width="256" height="134" rx="18" fill="#fff" opacity="0.78"/>
      <rect x="72" y="78" width="70" height="18" rx="6" fill="#f2b880"/>
      <rect x="72" y="108" width="140" height="14" rx="6" fill="#f4c7a0"/>
      <rect x="72" y="132" width="180" height="14" rx="6" fill="#f4c7a0"/>
      <rect x="72" y="156" width="120" height="14" rx="6" fill="#f4c7a0"/>
      <circle cx="250" cy="90" r="22" fill="#f7b267"/>
    </svg>
  `,
  city: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#c5d6f6"/>
          <stop offset="100%" stop-color="#7aa2d7"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <rect x="70" y="70" width="52" height="90" rx="6" fill="#1f3b5c" opacity="0.85"/>
      <rect x="132" y="50" width="70" height="110" rx="6" fill="#2b4d74" opacity="0.9"/>
      <rect x="214" y="80" width="60" height="80" rx="6" fill="#375f8c" opacity="0.9"/>
      <rect x="90" y="90" width="16" height="12" rx="3" fill="#d9e7ff"/>
      <rect x="90" y="110" width="16" height="12" rx="3" fill="#d9e7ff"/>
      <rect x="150" y="74" width="18" height="12" rx="3" fill="#d9e7ff"/>
    </svg>
  `,
  beach: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#7dd3fc"/>
          <stop offset="100%" stop-color="#38bdf8"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <circle cx="80" cy="70" r="26" fill="#fde68a"/>
      <path d="M0 150c60-20 120-20 180 0s120 20 180 0v70H0Z" fill="#f9e1b2"/>
      <path d="M0 130c60-15 120-15 180 0s120 15 180 0" fill="none" stroke="#e0f2fe" stroke-width="8"/>
    </svg>
  `,
  island: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#4cc9f0"/>
          <stop offset="100%" stop-color="#90dbf4"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <path d="M90 160c20-30 50-45 90-45s70 15 90 45" fill="#f8d8a8"/>
      <path d="M150 140c10-26 30-40 60-40" fill="none" stroke="#2a9d8f" stroke-width="10" stroke-linecap="round"/>
      <path d="M210 100c5-18 20-26 40-22" fill="none" stroke="#2a9d8f" stroke-width="8" stroke-linecap="round"/>
    </svg>
  `,
  heritage: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#f3d5b5"/>
          <stop offset="100%" stop-color="#d4a373"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <path d="M80 140h200l-20-60-80-30-80 30-20 60Z" fill="#9c6644" opacity="0.9"/>
      <rect x="110" y="140" width="140" height="40" rx="6" fill="#7f5539"/>
      <rect x="155" y="120" width="50" height="60" rx="6" fill="#fefae0" opacity="0.9"/>
    </svg>
  `,
  food: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#ffd6a5"/>
          <stop offset="100%" stop-color="#fd7f6f"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <path d="M90 140c0 36 36 60 90 60s90-24 90-60H90Z" fill="#fff" opacity="0.8"/>
      <path d="M120 110c0 20 20 20 20 40M170 100c0 20 20 20 20 40M220 110c0 20-20 20-20 40" fill="none" stroke="#fff" stroke-width="8" stroke-linecap="round"/>
    </svg>
  `,
  transport: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#94a3b8"/>
          <stop offset="100%" stop-color="#64748b"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <rect x="80" y="70" width="200" height="90" rx="30" fill="#f8fafc" opacity="0.85"/>
      <circle cx="120" cy="150" r="10" fill="#475569"/>
      <circle cx="240" cy="150" r="10" fill="#475569"/>
      <rect x="120" y="90" width="120" height="16" rx="8" fill="#94a3b8"/>
    </svg>
  `,
  stay: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#cdb4db"/>
          <stop offset="100%" stop-color="#9d76c1"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <rect x="70" y="110" width="220" height="60" rx="18" fill="#fff" opacity="0.8"/>
      <rect x="90" y="90" width="90" height="30" rx="12" fill="#f1e6ff"/>
      <rect x="70" y="160" width="220" height="12" rx="6" fill="#7c4ca2" opacity="0.7"/>
    </svg>
  `,
  basics: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#bde0fe"/>
          <stop offset="100%" stop-color="#8ecae6"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <circle cx="180" cy="110" r="60" fill="#fff" opacity="0.8"/>
      <path d="M180 70l20 50-50-20 30-30Z" fill="#219ebc" opacity="0.9"/>
      <circle cx="180" cy="110" r="8" fill="#023047"/>
    </svg>
  `,
  shopping: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#ffb703"/>
          <stop offset="100%" stop-color="#fb8500"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <rect x="110" y="80" width="140" height="110" rx="16" fill="#fff" opacity="0.8"/>
      <path d="M140 80v-12a20 20 0 0 1 40 0v12" fill="none" stroke="#ffb703" stroke-width="10" stroke-linecap="round"/>
      <circle cx="155" cy="125" r="8" fill="#fb8500"/>
      <circle cx="205" cy="125" r="8" fill="#fb8500"/>
    </svg>
  `,
  safety: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#adb5bd"/>
          <stop offset="100%" stop-color="#6c757d"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <path d="M180 60l80 30v50c0 40-30 64-80 80-50-16-80-40-80-80V90l80-30Z" fill="#fff" opacity="0.8"/>
      <path d="m150 130 20 20 40-40" fill="none" stroke="#6c757d" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  `,
  airport: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#90e0ef"/>
          <stop offset="100%" stop-color="#48cae4"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <path d="M60 120l240-20-240-20v40Z" fill="#fff" opacity="0.85"/>
      <path d="M150 100l-30-50M150 120l-30 50" stroke="#00b4d8" stroke-width="10" stroke-linecap="round"/>
      <circle cx="270" cy="70" r="16" fill="#fff" opacity="0.7"/>
    </svg>
  `,
};

const imageThemeMap: Record<string, string> = {
  planning: "planning",
  city: "city",
  beach: "beach",
  island: "island",
  heritage: "heritage",
  food: "food",
  transport: "transport",
  stay: "stay",
  basics: "basics",
  shopping: "shopping",
  safety: "safety",
  airport: "airport",
};

const leafImageNames = [
  "1 Month in Korea",
  "2 Weeks in Korea",
  "7 Days in Korea",
  "Basic Korean",
  "Been Here Before",
  "Best Value Places",
  "Budget Stays",
  "Busan",
  "Discount Passes",
  "Finding Good Restaurants",
  "First Time in Korea",
  "Food for First-Timers",
  "Food to Be Careful With",
  "From Airport to City",
  "Good Places Without Crowds",
  "Gyeongju",
  "How Much Does It Cost",
  "How to Get Discounts",
  "How to Pay in Korea",
  "Immigration Process",
  "In Case of Emergency",
  "Is Getting Around Hard",
  "Is Korea Safe",
  "Is Shopping Cheap in Korea",
  "Jeju",
  "Jeonju",
  "Latest Travel Updates for Korea",
  "Luxury Hotels",
  "Must-See for First Timers",
  "Renting a Car",
  "SIM or eSIM",
  "Saving on Transport",
  "Seoul",
  "Shopping in Busan",
  "Shopping in Seoul",
  "Solo Travel Safety",
  "Taking the Bus",
  "Tax Refund Explained",
  "Top Places by City",
  "Transfers Explained",
  "Transportation Cards",
  "Using Taxis",
  "Using the Subway",
  "What Is K-ETA",
  "What Should I Prepare",
  "What Should I Try First",
  "Where to Stay in Busan",
  "Where to Stay in Seoul",
  "Which City Fits You Best",
] as const;

const normalizeLeafTitle = (value: string) =>
  value
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, " ")
    .trim();

const normalizeLeafSlug = (value: string) =>
  value
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "");

const leafImageNameMap = new Map(
  leafImageNames.map((name) => [normalizeLeafTitle(name), name])
);

const leafImageSlugMap = new Map(
  leafImageNames.map((name) => [normalizeLeafSlug(name), name])
);

const IMAGE_ASSET_VERSION = "20260215b";

const toCardThumbPath = (value: string) => {
  if (!value.startsWith("/") || !/\.webp($|\?)/i.test(value)) {
    return value;
  }

  const [path, query = ""] = value.split("?");
  let nextPath = path;

  if (!nextPath.includes("/thumbs/")) {
    if (nextPath.startsWith("/leaf%20images/")) {
      nextPath = nextPath.replace("/leaf%20images/", "/leaf%20images/thumbs/");
    } else if (nextPath.startsWith("/leaf images/")) {
      nextPath = nextPath.replace("/leaf images/", "/leaf images/thumbs/");
    } else if (!/^\/(?:hanok-hero-home|hanok-hero|hero)\.webp$/i.test(nextPath)) {
      nextPath = `/thumbs${nextPath}`;
    }
  }

  return query ? `${nextPath}?${query}` : nextPath;
};

const withLocalWebpVersion = (value: string) => {
  if (!value.startsWith("/") || !/\.webp($|\?)/i.test(value) || /(?:\?|&)v=/.test(value)) {
    return value;
  }
  return `${value}${value.includes("?") ? "&" : "?"}v=${IMAGE_ASSET_VERSION}`;
};

const toCardThumbVariantPath = (value: string, variant: "w384" | "w640") => {
  if (!value.startsWith("/") || !/\.webp($|\?)/i.test(value)) {
    return value;
  }

  const [path, query = ""] = value.split("?");
  let nextPath = path;

  if (nextPath.startsWith("/leaf%20images/thumbs/")) {
    nextPath = nextPath.replace("/leaf%20images/thumbs/", `/leaf%20images/thumbs-${variant}/`);
  } else if (nextPath.startsWith("/leaf images/thumbs/")) {
    nextPath = nextPath.replace("/leaf images/thumbs/", `/leaf images/thumbs-${variant}/`);
  } else if (nextPath.startsWith("/thumbs/")) {
    nextPath = nextPath.replace("/thumbs/", `/thumbs-${variant}/`);
  } else {
    return value;
  }

  return query ? `${nextPath}?${query}` : nextPath;
};

type ResponsiveImageSource = {
  src: string;
  srcSet?: string;
};

const getImage = (key?: string, title?: string, slug?: string) => {
  if (key && (key.startsWith("/") || key.includes(".webp"))) {
    return withLocalWebpVersion(toCardThumbPath(key));
  }
  if (title) {
    const matchedName = leafImageNameMap.get(normalizeLeafTitle(title));
    if (matchedName) {
      return withLocalWebpVersion(
        toCardThumbPath(`/leaf%20images/${encodeURIComponent(matchedName)}.webp`)
      );
    }
  }
  if (slug) {
    const matchedBySlug = leafImageSlugMap.get(normalizeLeafSlug(slug));
    if (matchedBySlug) {
      return withLocalWebpVersion(
        toCardThumbPath(`/leaf%20images/${encodeURIComponent(matchedBySlug)}.webp`)
      );
    }
  }
  const theme = key ? imageThemeMap[key] ?? "basics" : "basics";
  const svg = imageSvgs[theme] ?? imageSvgs.basics;
  return toDataUri(svg);
};

const getResponsiveImage = (key?: string, title?: string, slug?: string): ResponsiveImageSource => {
  const src = getImage(key, title, slug);
  const w384 = toCardThumbVariantPath(src, "w384");
  const w640 = toCardThumbVariantPath(src, "w640");
  const hasBothVariants = w384 !== src && w640 !== src;

  return {
    src: hasBothVariants ? w384 : src,
    srcSet: hasBothVariants ? `${w384} 1x, ${w640} 2x` : w384 !== src ? `${w384} 1x, ${src} 2x` : undefined,
  };
};

const editorialMeta = getEditorialMeta(lang, node.updatedIso);
const latestUpdatesPath = withLang("/latest-travel-updates-for-korea", lang);
const nowMorePath = withLang("/korea-now-and-more", lang);
const thisWeekPath = withLang("/this-week-in-korea", lang);
const isLeafPage = !isHome && !hasChildren;
const rootSlug = segments[0] ?? "";
const showLeafMetaNote = isLeafPage;
const centerCardIconForPage =
  rootSlug === "latest-travel-updates-for-korea" || rootSlug === "korea-now-and-more";
const answerImage = getResponsiveImage(node.image ?? node.icon, node.title, node.slug);

const checklistByRoot: Record<string, string[]> = {
  "plan-your-trip": [
    "I chose my trip length and one backup plan.",
    "I confirmed my first city and first-night stay.",
    "I bookmarked the latest updates page before booking."
  ],
  "choose-a-city": [
    "I picked one main city and one optional contrast city.",
    "I checked seasonal weather for my travel dates.",
    "I compared transit time between selected cities."
  ],
  "where-to-stay": [
    "I chose an area near transit, not only a cheap room.",
    "I checked late check-in and luggage storage policy.",
    "I saved the hotel address in map and screenshot form."
  ],
  "getting-around-korea": [
    "I know how I will go from airport to hotel.",
    "I decided which transit card or pass to use first.",
    "I checked if weekend/holiday schedule changes affect my route."
  ],
  "travel-basics": [
    "I picked SIM/eSIM/Wi-Fi based on my phone.",
    "I prepared one card and a small amount of cash.",
    "I saved emergency numbers (112 / 119 / 1330)."
  ],
  "before-you-go": [
    "I verified entry and authorization requirements.",
    "I prepared passport and key booking confirmations.",
    "I checked latest updates within 24 hours before departure."
  ],
};

const defaultChecklist = [
  "I reviewed the key points on this page.",
  "I checked the latest travel updates before making decisions.",
  "I saved this page for quick access during my trip."
];

const leafChecklist = checklistByRoot[rootSlug] ?? defaultChecklist;

const joinPath = (base: string, slug: string) => {
  const normalizedBase = base === "/" ? "" : base.replace(/\/+$/, "");
  return `${normalizedBase}/${slug}`;
};

const { parent } = isLeafPage ? findNodeBySegments(segments) : { parent: undefined };
const siblingLeaves = (parent?.children ?? []).filter((child) => !child.children?.length);
const currentLeafIndex = siblingLeaves.findIndex((child) => child.slug === node.slug);
const nextLeaf =
  siblingLeaves.length > 1 && currentLeafIndex >= 0
    ? siblingLeaves[(currentLeafIndex + 1) % siblingLeaves.length]
    : undefined;
const leafNextOverrides: Record<string, { path: string; label: string }> = {
  "travel-insurance-for-korea": {
    path: withLang("/before-you-go/what-should-i-prepare", lang),
    label:
      lang === "es"
        ? "Checklist antes de viajar (5 min)"
        : "Before You Go Checklist (5 min)",
  },
};
const nextOverride = leafNextOverrides[node.slug ?? ""];
const nextDecisionPath =
  nextOverride?.path ??
  (nextLeaf ? withLang(joinPath(parentPath, nextLeaf.slug), lang) : latestUpdatesPath);
const nextDecisionLabel =
  nextOverride?.label ??
  (nextLeaf
    ? `${nextLeaf.title} (${lang === "es" ? "guia de 5 min" : "5-min guide"})`
    : t.nextFallback);
const checklistStorageKey = segments.join("/") || node.slug || "leaf";
const contentBlockCount = node.content?.length ?? 0;
const middleContentIndex =
  contentBlockCount > 0 ? Math.max(1, Math.floor((contentBlockCount - 1) / 2)) : -1;
const showHomeUpdateBar = isHome && segments.length === 0 && !node.slug;
const homeUpdateTickerItems = showHomeUpdateBar ? await getHomeLeafTickerItems(siteTree) : [];
const hubFaqItems = hasChildren && !isHome ? getHubFaqItems(node, lang) : [];
const leafFaqItems = isLeafPage ? getLeafFaqItems(node, lang) : [];
const collectionQuickSummary =
  hasChildren && !isHome ? node.quickAnswer ?? getHubQuickSummary(node, lang) : undefined;
const leafQuickAnswerSeed = (node.quickAnswer ?? node.description ?? t.quickFallback).trim();
const leafQuickAnswerNeedsSupport =
  leafQuickAnswerSeed.length < 120 &&
  (leafQuickAnswerSeed.match(/[.!?](?=\s|$)/g)?.length ?? 0) < 2;
const leafQuickAnswerText =
  isLeafPage && leafQuickAnswerNeedsSupport
    ? `${leafQuickAnswerSeed}${/[.!?]$/.test(leafQuickAnswerSeed) ? "" : "."} ${t.leafQuickSupport}`
    : leafQuickAnswerSeed;

const breadcrumb = breadcrumbs;
---

<section class="hero">
  <div>
    <div class="hero-tools">
      <div class="lang-switcher">
        <span class="lang-label" id="lang-switcher-label">{t.language}</span>
        <div class="lang-segment" role="group" aria-labelledby="lang-switcher-label">
          <button type="button" class="lang-option" data-lang-button="en" aria-pressed={lang === "en"}>
            {t.english}
          </button>
          <button type="button" class="lang-option" data-lang-button="es" aria-pressed={lang === "es"}>
            {t.spanish}
          </button>
        </div>
        <select id="lang-switcher" class="lang-select" data-lang-switcher aria-label={t.language}>
          <option value="en" selected={lang === "en"}>{t.english}</option>
          <option value="es" selected={lang === "es"}>{t.spanish}</option>
        </select>
      </div>
    </div>
    <p class="eyebrow">{t.plannerName}</p>
    <h1 class="t-h1">{isHome ? t.homeTitle : node.title}</h1>
    {!isHome && (
      <div class="nav-links">
        <a href={withLang(parentPath, lang)} aria-label={t.backAria}>← {t.back}</a>
        <span class="nav-sep" aria-hidden="true">·</span>
        <a href={withLang("/", lang)} aria-label={t.homeAria}>{t.home}</a>
      </div>
    )}
    <p class="lead t-subheading">
      {isHome ? (
        t.homeLead
      ) : (
        node.description ?? t.nextSet
      )}
    </p>
  </div>
</section>

<section
  class="section"
  data-kpi-section={isHome ? "home_main" : hasChildren ? `collection_${node.slug ?? "root"}` : "leaf_content"}
>
  <div class="section-header">
    <h2 class="t-section">{isHome ? t.startHere : hasChildren ? t.pickSub : t.quickAnswer}</h2>
    <p>
      {isHome
        ? t.homeSectionDesc
        : hasChildren
        ? collectionQuickSummary ?? t.subSectionDesc
        : leafQuickAnswerText}
    </p>
  </div>
  {showHomeUpdateBar && homeUpdateTickerItems.length > 0 && (
    <div class="home-update-bar" data-update-bar>
      <p class="home-update-label">{t.updateTickerLabel}</p>
      <div class="home-update-view" aria-live="off">
        {homeUpdateTickerItems.map((item, index) => (
          <a
            class={`home-update-line${index === 0 ? " is-active" : ""}`}
            href={withLang(item.path, lang)}
            data-update-line
            data-kpi-section={`home_update_bar_${index + 1}`}
          >
            <span class="home-update-leaf">{item.leafTitle}</span>
            <span class="home-update-sep" aria-hidden="true">:</span>
            <span class="home-update-detail">{item.detail}</span>
          </a>
        ))}
      </div>
    </div>
  )}
  {isHome && showHomeUpdateBar && homeUpdateTickerItems.length > 0 && (
    <div data-kpi-section="home_ad_after_updates">
      <AdSenseSafeSlot zone="home_after_update_bar" className="ad-safe-spacing ad-safe-spacing--home" />
    </div>
  )}

  {hasChildren ? (
    <>
      <div class="grid" data-orphans={children.length % 3}>
        {children.map((child, index) => {
          const cardImage = getResponsiveImage(child.image ?? child.icon, child.title, child.slug);

          return (
            <a
              class="card"
              href={withLang(`${basePath}/${child.slug}`, lang)}
              data-tone={getTone(child.icon)}
              data-card-link
              data-card-title={child.title}
              data-kpi-section={isHome ? "home_card_grid" : `collection_${node.slug ?? "root"}_cards`}
            >
              <div class="thumb">
                <img
                  src={cardImage.src}
                  srcset={cardImage.srcSet}
                  alt={child.title}
                  loading={isHome ? (index === 0 ? "eager" : "lazy") : index < 2 ? "eager" : "lazy"}
                  fetchpriority={isHome ? (index === 0 ? "high" : "low") : index === 0 ? "high" : "auto"}
                  decoding="async"
                  width="360"
                  height="220"
                />
                <span class="thumb-mask" aria-hidden="true"></span>
              </div>
              <div class="card-body">
                <div>
                  <h3 class="t-card-title">{child.title}</h3>
                  <p class="t-card-desc">{child.description ?? t.cardFallback}</p>
                </div>
              </div>
            </a>
          );
        })}
      </div>
      {!isHome && (
        <div data-kpi-section={`collection_${node.slug ?? "root"}_ad_after_grid`}>
          <AdSenseSafeSlot zone="hub_after_grid" className="ad-safe-spacing ad-safe-spacing--hub" />
        </div>
      )}
      {hubFaqItems.length > 0 && (
        <div class="hub-faq" data-kpi-section={`collection_${node.slug ?? "root"}_faq`}>
          <h3 class="t-section">{t.hubFaqTitle}</h3>
          <div class="hub-faq-list">
            {hubFaqItems.map((item) => (
              <article class="hub-faq-item">
                <h4>{item.question}</h4>
                <p>{item.answer}</p>
              </article>
            ))}
          </div>
        </div>
      )}
    </>
  ) : (
    <div class="answer">
      <div class="answer-hero">
        <div class="answer-thumb">
          <img
            src={answerImage.src}
            srcset={answerImage.srcSet}
            alt={node.title}
            loading="eager"
            fetchpriority="high"
            decoding="async"
            width="360"
            height="220"
          />
          <span class="thumb-mask" aria-hidden="true"></span>
        </div>
        <div>
          <h3 class="t-section">{node.title}</h3>
          <p class="t-subheading">{node.description ?? t.guidePreparing}</p>
        </div>
      </div>
      {node.content?.map((section, index) => (
        <Fragment>
          <div
            class="content-block"
            data-tone={getTone(section.icon)}
            data-icon-align={centerCardIconForPage ? "center" : undefined}
          >
            <div class="content-title">
              {section.icon && (
                <span class="content-icon" set:html={renderIcon(section.icon)} />
              )}
              <h4 class="t-section">{section.title}</h4>
            </div>
            {section.emphasis && (
              <p class="content-emphasis">{section.emphasis}</p>
            )}
            <p set:html={linkify(section.body)} />
            {section.subsections && section.subsections.length > 0 && (
              <div class="content-subsections">
                {section.subsections.map((subsection) => (
                  <div class="content-subsection">
                    <p class:list={["content-subtitle", subsection.plainTitle && "content-subtitle--plain"]}>
                      {subsection.title}
                    </p>
                    {subsection.bullets && subsection.bullets.length > 0 && (
                      <ul class="content-sublist">
                        {subsection.bullets.map((bullet) => (
                          <li set:html={linkify(bullet)} />
                        ))}
                      </ul>
                    )}
                    {subsection.tail && (
                      <p class="content-tail" set:html={linkify(subsection.tail)} />
                    )}
                  </div>
                ))}
              </div>
            )}
            {section.bullets && (
              <ul>
                {section.bullets.map((bullet) => (
                  <li set:html={linkify(bullet)} />
                ))}
              </ul>
            )}
            {section.tail && (
              <p class="content-tail" set:html={linkify(section.tail)} />
            )}
          </div>
          {isLeafPage && index === 0 && (
            <AdSenseSafeSlot zone="leaf_after_intro" className="ad-safe-spacing ad-safe-spacing--intro" />
          )}
          {isLeafPage && contentBlockCount >= 4 && index === middleContentIndex && (
            <AdSenseSafeSlot zone="leaf_mid_content" className="ad-safe-spacing ad-safe-spacing--middle" />
          )}
        </Fragment>
      ))}
      <div class="content-identity">
        <span class="content-identity-icon" aria-hidden="true" set:html={renderIcon("spark")} />
        <span>{t.identity}</span>
      </div>
      {isLeafPage && (
        <AdSenseSafeSlot zone="leaf_end_content" className="ad-safe-spacing ad-safe-spacing--end" />
      )}
      {isLeafPage && leafFaqItems.length > 0 && (
        <div class="leaf-faq" data-kpi-section="leaf_faq">
          <h3 class="t-section">{t.leafFaqTitle}</h3>
          <div class="leaf-faq-list">
            {leafFaqItems.map((item) => (
              <article class="leaf-faq-item">
                <h4>{item.question}</h4>
                <p>{item.answer}</p>
              </article>
            ))}
          </div>
        </div>
      )}
      {isLeafPage && (
        <div class="leaf-tools">
          {showLeafMetaNote && (
            <p class="leaf-meta">
              <span class="leaf-meta-icon" aria-hidden="true" set:html={renderIcon("calendar")} />
              <strong>{t.updatedLabel}:</strong> {editorialMeta.updatedText}
              <span aria-hidden="true"> · </span>
              <span>{t.sourceNote}</span>
            </p>
          )}

          <div class="leaf-next">
            <p class="leaf-tools-label">{t.nextDecision}</p>
            <a class="leaf-next-link" href={nextDecisionPath} data-kpi-section="leaf_next_decision">
              <span class="leaf-next-prefix">{t.nextPrefix}</span>
              <strong>{nextDecisionLabel}</strong>
            </a>
            <p class="leaf-next-hint">{t.nextDecisionHint}</p>
          </div>

          <div class="leaf-return">
            <p class="leaf-tools-label">{t.returnCheckpoints}</p>
            <div class="leaf-return-links">
              <a href={latestUpdatesPath} data-kpi-section="leaf_return_latest">{t.returnLatest}</a>
              <a href={nowMorePath} data-kpi-section="leaf_return_now_more">{t.returnNowMore}</a>
              <a href={thisWeekPath} data-kpi-section="leaf_return_this_week">{t.returnThisWeek}</a>
            </div>
          </div>

          <div class="leaf-checklist-wrap">
            <p class="leaf-tools-label">{t.quickChecklist}</p>
            <p class="leaf-checklist-hint">{t.checklistHint}</p>
            <ul class="leaf-checklist-list" data-leaf-checklist data-checklist-key={checklistStorageKey}>
              {leafChecklist.map((item, index) => (
                <li>
                  <label>
                    <input type="checkbox" data-checklist-item={index} />
                    <span>{item}</span>
                  </label>
                </li>
              ))}
            </ul>
            <p class="leaf-bookmark-tip">{t.bookmarkTip}</p>
          </div>
        </div>
      )}
    </div>
  )}
</section>

{isHome && (
  <section class="section light">
    <div class="section-header">
      <h2 class="t-section">{t.homeCtaTitle}</h2>
      <p>{t.homeCtaDesc}</p>
    </div>
    <div class="pill-row">
      <a class="pill" href={withLang("/plan-your-trip/7-days-in-korea", lang)} data-kpi-section="home_pill_days">{t.pillDays}</a>
      <a class="pill" href={withLang("/travel-basics/sim-or-esim", lang)} data-kpi-section="home_pill_sim">{t.pillSim}</a>
      <a class="pill" href={withLang("/getting-around-korea/using-the-subway", lang)} data-kpi-section="home_pill_subway">{t.pillSubway}</a>
      <a class="pill" href={withLang("/choose-a-city/which-city-fits-you-best", lang)} data-kpi-section="home_pill_city">{t.pillCityFit}</a>
      <a class="pill" href={nowMorePath} data-kpi-section="home_pill_now_more">{t.pillNowMore}</a>
    </div>
    <div class="feedback-cta" data-kpi-section="home_feedback_section">
      <p class="feedback-eyebrow">{t.feedbackEyebrow}</p>
      <h3 class="feedback-title">{t.feedbackTitle}</h3>
      <p class="feedback-desc">{t.feedbackDesc}</p>
      <a
        class="feedback-link"
        href={FEEDBACK_FORM_URL}
        target="_blank"
        rel="noopener noreferrer"
        data-kpi-section="home_feedback_form"
      >
        {t.feedbackButton}
      </a>
      <p class="feedback-note">{t.feedbackNote}</p>
    </div>
  </section>
)}

<script is:inline>
  (() => {
    const select = document.querySelector("[data-lang-switcher]");
    if (!select) return;
    const langButtons = Array.from(document.querySelectorAll("[data-lang-button]"));
    const normalizePath = (pathname) => {
      if (!pathname) return "/";
      return pathname.startsWith("/") ? pathname : `/${pathname}`;
    };
    const stripEsPrefix = (pathname) => {
      const normalized = normalizePath(pathname);
      if (normalized === "/es") return "/";
      if (normalized.startsWith("/es/")) {
        const stripped = normalized.slice(3);
        return stripped || "/";
      }
      return normalized;
    };
    const toLangPath = (pathname, targetLang) => {
      const base = stripEsPrefix(pathname);
      if (targetLang === "es") {
        return base === "/" ? "/es" : `/es${base}`;
      }
      return base;
    };
    const isSpanishPath = (pathname) => {
      const normalized = normalizePath(pathname);
      return normalized === "/es" || normalized.startsWith("/es/");
    };
    const getCurrentLang = () => {
      return isSpanishPath(window.location.pathname) ? "es" : "en";
    };

    const normalizeInternalHref = (rawHref, targetLang) => {
      if (
        !rawHref ||
        rawHref.startsWith("#") ||
        rawHref.startsWith("mailto:") ||
        rawHref.startsWith("tel:") ||
        rawHref.startsWith("javascript:")
      ) {
        return null;
      }
      const next = new URL(rawHref, window.location.origin);
      if (next.origin !== window.location.origin) return null;
      next.pathname = toLangPath(next.pathname, targetLang);
      next.searchParams.delete("lang");
      return `${next.pathname}${next.search}${next.hash}`;
    };

    const syncInternalLinks = (targetLang) => {
      const anchors = document.querySelectorAll("a[href]");
      anchors.forEach((anchor) => {
        const normalized = normalizeInternalHref(anchor.getAttribute("href"), targetLang);
        if (!normalized) return;
        anchor.setAttribute("href", normalized);
      });
    };

    const syncLangButtons = (activeLang) => {
      langButtons.forEach((button) => {
        const isActive = button.getAttribute("data-lang-button") === activeLang;
        button.setAttribute("aria-pressed", isActive ? "true" : "false");
        button.toggleAttribute("data-active", isActive);
      });
    };
    const resyncLanguageUi = () => {
      const activeLang = getCurrentLang();
      select.value = activeLang;
      syncLangButtons(activeLang);
      syncInternalLinks(activeLang);
    };
    resyncLanguageUi();
    window.setTimeout(resyncLanguageUi, 250);
    window.addEventListener("pageshow", resyncLanguageUi);
    window.addEventListener("popstate", () => {
      window.setTimeout(resyncLanguageUi, 0);
    });

    document.addEventListener(
      "click",
      (event) => {
        const target = event.target;
        if (!(target instanceof Element)) return;
        const anchor = target.closest("a[href]");
        if (!anchor) return;
        const rawHref = anchor.getAttribute("href");
        const normalized = normalizeInternalHref(rawHref, getCurrentLang());
        if (!normalized) return;
        if (rawHref === normalized) return;
        event.preventDefault();
        window.location.href = normalized;
      },
      true
    );

    select.addEventListener("change", () => {
      const nextLang = select.value === "es" ? "es" : "en";
      syncLangButtons(nextLang);

      const url = new URL(window.location.href);
      url.pathname = toLangPath(url.pathname, nextLang);
      url.searchParams.delete("lang");
      if (url.hash.startsWith("#googtrans")) {
        url.hash = "";
      }
      window.location.href = url.toString();
    });

    langButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const targetLang = button.getAttribute("data-lang-button") === "es" ? "es" : "en";
        if (targetLang === select.value) return;
        select.value = targetLang;
        select.dispatchEvent(new Event("change"));
      });
    });
  })();
</script>

<script is:inline>
  (() => {
    const bars = Array.from(document.querySelectorAll("[data-update-bar]"));
    if (!bars.length) return;
    if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;

    bars.forEach((bar) => {
      const lines = Array.from(bar.querySelectorAll("[data-update-line]"));
      if (lines.length < 2) return;

      let currentIndex = 0;
      window.setInterval(() => {
        const current = lines[currentIndex];
        const nextIndex = (currentIndex + 1) % lines.length;
        const next = lines[nextIndex];

        current.classList.remove("is-active");
        current.classList.add("is-exit");
        next.classList.remove("is-exit");
        next.classList.add("is-active");

        window.setTimeout(() => {
          current.classList.remove("is-exit");
        }, 640);

        currentIndex = nextIndex;
      }, 6500);
    });
  })();
</script>

<script is:inline>
  (() => {
    const checklist = document.querySelector("[data-leaf-checklist]");
    if (!checklist) return;
    const keyBase = checklist.getAttribute("data-checklist-key");
    if (!keyBase) return;

    const storageKey = `visitkorea_checklist_${keyBase}`;
    const items = Array.from(checklist.querySelectorAll("[data-checklist-item]"));
    if (!items.length) return;

    const readSavedState = () => {
      try {
        const raw = window.localStorage.getItem(storageKey);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    };

    const writeSavedState = () => {
      try {
        const state = items.map((input) => {
          if (!(input instanceof HTMLInputElement)) return false;
          return input.checked;
        });
        window.localStorage.setItem(storageKey, JSON.stringify(state));
      } catch {
        // Ignore storage errors and keep checklist usable.
      }
    };

    const saved = readSavedState();
    items.forEach((input, index) => {
      if (!(input instanceof HTMLInputElement)) return;
      input.checked = Boolean(saved[index]);
      input.addEventListener("change", writeSavedState);
    });
  })();
</script>

<style>
  .hero {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: center;
    text-align: center;
    margin-bottom: 36px;
    padding: 30px 26px;
    border-radius: var(--radius-xl);
    border: 1px solid var(--border-dark);
    overflow: hidden;
  }

  .hero > div {
    position: relative;
    z-index: 1;
    max-width: 760px;
  }

  .hero-tools {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-bottom: 12px;
  }

  .lang-switcher {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    border-radius: 999px;
    border: 1px solid var(--border-dark);
    background: linear-gradient(180deg, rgba(18, 14, 11, 0.72), rgba(12, 9, 8, 0.68));
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.24);
    backdrop-filter: blur(5px);
  }

  .lang-label {
    font-size: 0.78rem;
    letter-spacing: 0.03em;
    color: var(--text-muted);
  }

  .lang-segment {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.04);
  }

  .lang-option {
    border: 0;
    border-radius: 999px;
    background: transparent;
    color: var(--text-soft);
    font-size: 0.82rem;
    font-weight: 600;
    letter-spacing: 0.01em;
    line-height: 1;
    padding: 8px 14px;
    min-width: 84px;
    cursor: pointer;
    transition: color 180ms ease, background-color 180ms ease, box-shadow 200ms ease, transform 180ms ease;
  }

  .lang-option:hover {
    color: var(--text-strong);
    background: rgba(255, 255, 255, 0.09);
  }

  .lang-option:focus-visible {
    outline: none;
    box-shadow: 0 0 0 2px rgba(124, 92, 255, 0.5);
  }

  .lang-option[data-active] {
    color: var(--ink-strong);
    background: linear-gradient(180deg, var(--paper), var(--paper-2));
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.18);
    transform: translateY(-1px);
  }

  .lang-select {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .home-bg .hero::before {
    content: "";
    position: absolute;
    inset: 0;
    background:
      radial-gradient(980px 520px at 50% 24%, rgba(0, 0, 0, 0.28), transparent 63%),
      linear-gradient(180deg, rgba(18, 14, 11, 0.68), rgba(18, 14, 11, 0.48));
    z-index: 0;
    pointer-events: none;
  }

  .home-bg .hero {
    background:
      linear-gradient(180deg, rgba(18, 14, 11, 0.24), rgba(15, 11, 9, 0.38)),
      url("/hanok-hero-home.webp?v=20260210q") center / cover no-repeat;
  }

  @media (max-width: 720px) {
    .home-bg .hero {
      background:
        linear-gradient(180deg, rgba(18, 14, 11, 0.24), rgba(15, 11, 9, 0.38)),
        url("/leaf%20images/thumbs/hanok_hero.webp?v=20260211a") center / cover no-repeat;
    }
  }

  .home-bg .lang-switcher {
    background: linear-gradient(180deg, rgba(20, 15, 12, 0.76), rgba(12, 9, 8, 0.64));
    border-color: rgba(255, 255, 255, 0.16);
  }

  .home-bg h1 {
    color: #fff9f2;
    text-shadow: 0 16px 36px rgba(0, 0, 0, 0.58);
  }

  .home-bg .lead {
    color: #f2ebe0;
    text-shadow: 0 10px 24px rgba(0, 0, 0, 0.52);
  }

  .home-bg .eyebrow {
    color: #e6dccd;
  }

  .eyebrow {
    text-transform: uppercase;
    font-size: 12px;
    letter-spacing: 0.18em;
    color: var(--text-muted);
    margin-bottom: 12px;
  }

  h1 {
    font-family: "Fraunces", serif;
    margin: 0 0 10px;
    color: var(--text-strong);
    max-width: 720px;
    white-space: normal;
    line-height: 1.14;
    letter-spacing: 0.012em;
    text-shadow: 0 10px 28px rgba(0, 0, 0, 0.45);
    overflow-wrap: anywhere;
  }

  .lead {
    color: var(--text-soft);
    margin: 0 0 20px;
    max-width: 680px;
    line-height: 1.55;
    letter-spacing: 0.006em;
    text-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
  }

  .button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 10px 18px;
    border-radius: 999px;
    background: var(--accent);
    color: var(--text-strong);
    font-weight: 600;
    border: 1px solid transparent;
    box-shadow: var(--shadow-1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .button:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-2);
  }

  .button.ghost {
    background: transparent;
    color: var(--accent);
    border-color: var(--ring);
    box-shadow: none;
  }

  .nav-links {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    font-size: 0.95rem;
    color: var(--text-muted);
    margin: 6px 0 14px;
  }

  .nav-links a {
    color: var(--text-soft);
    text-decoration: none;
    font-weight: 600;
  }

  .nav-links a:hover {
    color: var(--accent-hover);
  }

  .nav-sep {
    color: var(--text-muted);
  }

  .breadcrumbs {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-bottom: 26px;
  }

  .breadcrumbs a {
    color: var(--text-muted);
  }

  .crumb {
    color: var(--text-muted);
  }

  .crumb-group {
    display: inline-flex;
    gap: 8px;
    align-items: center;
  }

  .section {
    margin-bottom: 48px;
  }


  .section-header {
    margin-bottom: 24px;
  }

  .section-header h2 {
    margin: 0 0 8px;
    font-family: "Fraunces", serif;
    color: var(--text-strong);
  }

  .section-header p {
    margin: 0;
    max-width: 68ch;
    color: var(--text-soft);
    line-height: 1.6;
  }

  .home-update-bar {
    display: grid;
    grid-template-columns: auto minmax(0, 1fr);
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    padding: 7px 12px;
    min-height: 42px;
    border-radius: 12px;
    border: 1px solid color-mix(in srgb, var(--border-paper) 65%, #2d7ff9 35%);
    background: linear-gradient(
      180deg,
      color-mix(in srgb, #eef5ff 88%, var(--paper) 12%),
      color-mix(in srgb, #eef5ff 78%, var(--paper-2) 22%)
    );
    box-shadow: var(--shadow-1);
  }

  .home-update-label {
    margin: 0;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    width: fit-content;
    padding: 3px 8px;
    border-radius: 999px;
    border: 1px solid color-mix(in srgb, #2d7ff9 42%, #d6e6fb 58%);
    background: linear-gradient(
      180deg,
      color-mix(in srgb, #f7fbff 86%, #dfeeff 14%),
      color-mix(in srgb, #eef5ff 82%, #d9e9ff 18%)
    );
    font-family: "Plus Jakarta Sans", "Work Sans", system-ui, sans-serif;
    font-size: clamp(0.8rem, 0.98vw, 0.9rem);
    font-weight: 700;
    letter-spacing: 0.005em;
    line-height: 1.15;
    color: #16324f;
    white-space: nowrap;
    box-shadow: 0 8px 18px rgba(22, 50, 79, 0.12);
  }

  .home-update-label::before {
    content: "";
    width: 7px;
    height: 7px;
    border-radius: 999px;
    background: #2d7ff9;
    box-shadow: 0 0 0 3px rgba(45, 127, 249, 0.2);
  }

  .home-update-view {
    position: relative;
    min-width: 0;
    height: 1.35rem;
    overflow: hidden;
  }

  .home-update-line {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    gap: 7px;
    text-decoration: none;
    white-space: nowrap;
    overflow: hidden;
    transform: translateY(128%);
    opacity: 0;
    pointer-events: none;
    transition: transform 540ms cubic-bezier(0.22, 1, 0.36, 1), opacity 360ms ease;
  }

  .home-update-leaf {
    flex: 0 0 auto;
    font-family: "Fraunces", serif;
    font-size: 0.9rem;
    font-weight: 700;
    letter-spacing: 0.004em;
    color: var(--ink-strong);
  }

  .home-update-sep {
    flex: 0 0 auto;
    color: color-mix(in srgb, var(--ink-soft) 74%, #7c5cff 26%);
    font-weight: 700;
  }

  .home-update-detail {
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--ink-soft);
  }


  .home-update-line.is-active {
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto;
  }

  .home-update-line.is-exit {
    transform: translateY(-128%);
    opacity: 0;
  }

  .home-update-line:hover .home-update-leaf,
  .home-update-line:hover .home-update-detail {
    color: #1f66cc;
  }

  .section.light {
    background: var(--paper-2);
    padding: 28px 32px;
    border-radius: var(--radius-xl);
    border: 1px solid var(--border-paper);
    box-shadow: var(--shadow-1);
  }

  .section.light .section-header h2 {
    color: var(--ink-strong);
  }

  .section.light .section-header p {
    color: var(--ink-soft);
  }

  .feedback-cta {
    margin-top: 22px;
    padding-top: 20px;
    border-top: 1px solid var(--border-paper);
    display: grid;
    gap: 8px;
    max-width: 780px;
  }

  .feedback-eyebrow {
    margin: 0;
    font-size: 0.78rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-weight: 700;
    color: var(--ink-soft);
  }

  .feedback-title {
    margin: 0;
    font-family: "Fraunces", serif;
    color: var(--ink-strong);
    font-size: clamp(1.08rem, 1.45vw, 1.34rem);
    line-height: 1.32;
  }

  .feedback-desc {
    margin: 0;
    color: var(--ink-soft);
    line-height: 1.55;
    max-width: 62ch;
  }

  .feedback-link {
    width: fit-content;
    margin-top: 4px;
    padding: 10px 16px;
    border-radius: 999px;
    border: 1px solid rgba(124, 92, 255, 0.28);
    background: linear-gradient(180deg, rgba(124, 92, 255, 0.16), rgba(124, 92, 255, 0.1));
    color: var(--ink-strong);
    font-weight: 700;
    text-decoration: none;
    box-shadow: 0 8px 18px rgba(0, 0, 0, 0.16);
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
  }

  .feedback-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 22px rgba(0, 0, 0, 0.18);
    border-color: rgba(124, 92, 255, 0.42);
    color: var(--ink-strong);
  }

  .feedback-note {
    margin: 2px 0 0;
    font-size: 0.84rem;
    color: var(--ink-soft);
    opacity: 0.9;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 20px;
  }

  @media (min-width: 901px) {
    .grid[data-orphans="1"] .card:last-child {
      grid-column: 2 / 3;
      justify-self: stretch;
    }
  }

  .card {
    display: grid;
    grid-template-rows: auto 1fr;
    gap: 14px;
    padding: 20px 22px;
    background: var(--paper);
    border-radius: var(--radius-xl);
    border: 1px solid var(--border-paper);
    box-shadow: var(--shadow-1);
    transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    position: relative;
    overflow: hidden;
    text-decoration: none;
    color: var(--ink-soft);
  }

  .card:visited,
  .card:hover,
  .card:focus-visible {
    text-decoration: none;
    color: var(--ink-soft);
  }

  .card:hover,
  .card:focus-visible {
    transform: translateY(-2px);
    border-color: rgba(124, 92, 255, 0.25);
    box-shadow: var(--shadow-2);
  }

  .card:focus-visible {
    outline: 2px solid rgba(124, 92, 255, 0.35);
    outline-offset: 1px;
  }

  .card::after {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.28), transparent 65%);
    opacity: 0.4;
    pointer-events: none;
  }

  .card[data-tone="sea"]::after {
    background: radial-gradient(circle at 80% 0%, rgba(90, 178, 206, 0.35), transparent 65%);
  }

  .card[data-tone="gold"]::after {
    background: radial-gradient(circle at 80% 0%, rgba(245, 163, 91, 0.35), transparent 65%);
  }

  .card[data-tone="spice"]::after {
    background: radial-gradient(circle at 80% 0%, rgba(214, 101, 68, 0.35), transparent 65%);
  }

  .card[data-tone="lilac"]::after {
    background: radial-gradient(circle at 80% 0%, rgba(161, 150, 221, 0.35), transparent 65%);
  }

  .card[data-tone="mint"]::after {
    background: radial-gradient(circle at 80% 0%, rgba(105, 196, 176, 0.35), transparent 65%);
  }

  .card[data-tone="sky"]::after {
    background: radial-gradient(circle at 80% 0%, rgba(129, 183, 231, 0.35), transparent 65%);
  }

  .card[data-tone="sand"]::after {
    background: radial-gradient(circle at 80% 0%, rgba(234, 200, 148, 0.35), transparent 65%);
  }

  .card[data-tone="amber"]::after {
    background: radial-gradient(circle at 80% 0%, rgba(255, 200, 96, 0.35), transparent 65%);
  }

  .thumb {
    width: 100%;
    height: 128px;
    border-radius: 16px;
    background: linear-gradient(140deg, var(--paper), var(--paper-2));
    position: relative;
    overflow: hidden;
    border: 1px solid var(--border-paper);
    box-shadow: 0 10px 22px rgba(0, 0, 0, 0.18);
  }

  .thumb img {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover;
  }

  .thumb-mask {
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(18, 14, 11, 0.16), rgba(18, 14, 11, 0.02));
  }

  .card-body {
    display: block;
  }

  .card h3 {
    margin: 0 0 6px;
    color: var(--ink-strong);
    text-decoration: none;
  }

  .card p {
    margin: 0;
    color: var(--ink-soft);
    text-decoration: none;
  }

  .hub-faq {
    margin-top: 24px;
    padding: 22px;
    border-radius: var(--radius-xl);
    background: var(--paper);
    border: 1px solid var(--border-paper);
    box-shadow: var(--shadow-1);
  }

  .hub-faq h3 {
    margin: 0 0 14px;
    color: var(--ink-strong);
  }

  .hub-faq-list {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
  }

  .hub-faq-item {
    padding: 14px 15px;
    border-radius: 14px;
    border: 1px solid var(--border-paper);
    background: color-mix(in srgb, var(--paper) 88%, var(--paper-2) 12%);
  }

  .hub-faq-item h4 {
    margin: 0 0 6px;
    font-size: 0.95rem;
    color: var(--ink-strong);
  }

  .hub-faq-item p {
    margin: 0;
    font-size: 0.9rem;
    line-height: 1.55;
    color: var(--ink-soft);
  }

  .leaf-faq {
    margin-top: 22px;
    padding: 18px;
    border-radius: 16px;
    background: var(--paper);
    border: 1px solid var(--border-paper);
    box-shadow: var(--shadow-1);
  }

  .leaf-faq h3 {
    margin: 0 0 12px;
    color: var(--ink-strong);
  }

  .leaf-faq-list {
    display: grid;
    gap: 10px;
  }

  .leaf-faq-item {
    padding: 12px 13px;
    border-radius: 12px;
    border: 1px solid var(--border-paper);
    background: color-mix(in srgb, var(--paper) 86%, var(--paper-2) 14%);
  }

  .leaf-faq-item h4 {
    margin: 0 0 6px;
    font-size: 0.94rem;
    color: var(--ink-strong);
  }

  .leaf-faq-item p {
    margin: 0;
    font-size: 0.9rem;
    line-height: 1.55;
    color: var(--ink-soft);
  }


  .answer {
    display: flex;
    flex-direction: column;
    gap: 18px;
    padding: 22px;
    border-radius: var(--radius-xl);
    background: var(--paper);
    border: 1px solid var(--border-paper);
    box-shadow: var(--shadow-1);
  }

  .answer-hero {
    display: grid;
    grid-template-columns: minmax(0, 200px) 1fr;
    gap: 18px;
    align-items: center;
  }

  .answer-thumb {
    width: 100%;
    height: 140px;
    border-radius: 16px;
    background: linear-gradient(140deg, var(--paper), var(--paper-2));
    position: relative;
    overflow: hidden;
    border: 1px solid var(--border-paper);
    box-shadow: 0 10px 22px rgba(0, 0, 0, 0.18);
  }

  .answer-thumb img {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover;
  }

  .answer h3 {
    margin: 0 0 8px;
    color: var(--ink-strong);
  }

  .answer p {
    margin: 0;
    color: var(--ink-soft);
    line-height: 1.6;
  }

  .content-block h4 {
    margin: 0 0 6px;
    font-size: 1.05rem;
    color: var(--ink-strong);
  }

  .content-block p {
    margin: 0 0 8px;
    color: var(--ink-soft);
    line-height: 1.7;
  }

  .content-block ul {
    margin: 0;
    padding-left: 18px;
    color: var(--ink-soft);
    line-height: 1.6;
  }

  .content-subsections {
    margin: 2px 0 8px;
  }

  .content-subsection + .content-subsection {
    margin-top: 8px;
  }

  .content-subtitle {
    margin: 0 0 4px !important;
    font-family: "Plus Jakarta Sans", "Work Sans", system-ui, sans-serif;
    font-size: 1.02rem;
    font-weight: 700;
    line-height: 1.35;
    color: var(--ink-strong) !important;
  }

  .content-subtitle--plain {
    margin: 0 0 8px !important;
    font-family: inherit;
    font-size: 1rem;
    font-weight: 400;
    line-height: 1.7;
    color: var(--ink-soft) !important;
  }

  .content-sublist {
    margin: 0;
  }

  .content-tail {
    margin-top: 6px !important;
  }

  .content-block {
    position: relative;
    padding: 16px 18px 16px 20px;
    border-radius: 16px;
    background: var(--paper-2);
    border: 1px solid var(--border-paper);
    box-shadow: 0 10px 24px rgba(0, 0, 0, 0.2);
  }

  .content-block::before {
    content: "";
    position: absolute;
    left: 0;
    top: 10px;
    bottom: 10px;
    width: 4px;
    border-radius: 999px;
    background: var(--content-accent, var(--ring));
  }
  .content-identity {
    margin-top: 28px;
    padding: 16px 18px;
    border-radius: 14px;
    background: var(--paper-2);
    border: 1px solid var(--border-paper);
    color: var(--ink-soft);
    font-size: 15px;
    line-height: 1.6;
    text-align: center;
    box-shadow: 0 10px 24px rgba(0, 0, 0, 0.2);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }
  .content-identity-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    color: var(--accent);
  }
  .content-identity-icon svg {
    width: 18px;
    height: 18px;
    stroke: currentColor;
    fill: none;
    stroke-width: 1.6;
  }

  .leaf-tools {
    margin-top: 24px;
    display: grid;
    gap: 14px;
    padding: 18px;
    border-radius: 16px;
    background: var(--paper-2);
    border: 1px solid var(--border-paper);
    box-shadow: 0 10px 24px rgba(0, 0, 0, 0.2);
  }

  .leaf-tools-label {
    margin: 0 0 8px;
    font-size: 0.84rem;
    font-weight: 700;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: var(--ink-soft);
  }

  .leaf-next-link {
    display: inline-flex;
    flex-direction: column;
    gap: 2px;
    padding: 12px 14px;
    border-radius: 12px;
    background: var(--paper);
    border: 1px solid var(--border-paper);
    text-decoration: none;
    color: var(--ink-strong);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.14);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .leaf-next-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 14px 24px rgba(0, 0, 0, 0.18);
  }

  .leaf-next-prefix {
    font-size: 0.78rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--ink-soft);
  }

  .leaf-next-hint {
    margin: 7px 2px 0;
    font-size: 0.86rem;
    line-height: 1.45;
    color: var(--ink-soft);
  }

  .leaf-return-links {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .leaf-return-links a {
    display: inline-flex;
    align-items: center;
    padding: 8px 12px;
    border-radius: 999px;
    background: var(--paper);
    border: 1px solid var(--border-paper);
    color: var(--ink-strong);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .leaf-return-links a:hover {
    color: var(--accent-hover);
  }

  .leaf-checklist-hint {
    margin: 0 0 10px;
    color: var(--ink-soft);
    font-size: 0.95rem;
  }

  .leaf-checklist-list {
    margin: 0;
    padding: 0;
    list-style: none;
    display: grid;
    gap: 8px;
  }

  .leaf-checklist-list label {
    display: inline-flex;
    align-items: flex-start;
    gap: 10px;
    color: var(--ink-strong);
    font-size: 0.95rem;
    line-height: 1.55;
    cursor: pointer;
  }

  .leaf-checklist-list input[type="checkbox"] {
    margin-top: 3px;
    accent-color: var(--accent);
  }

  .leaf-bookmark-tip {
    margin: 10px 0 0;
    color: var(--ink-soft);
    font-size: 0.9rem;
  }

  .leaf-meta {
    margin: 0;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--border-paper);
    background: var(--paper);
    display: inline-flex;
    align-items: center;
    gap: 7px;
    color: var(--ink-soft);
    font-size: 0.92rem;
    line-height: 1.5;
  }

  .leaf-meta strong {
    color: var(--ink-strong);
  }

  .leaf-meta-icon {
    width: 15px;
    height: 15px;
    display: inline-flex;
    color: var(--accent);
  }

  .leaf-meta-icon svg {
    width: 15px;
    height: 15px;
    stroke: currentColor;
    fill: none;
    stroke-width: 1.7;
  }

  .ad-safe-spacing {
    margin-left: 2px;
    margin-right: 2px;
  }

  .ad-safe-spacing--intro {
    margin-top: 6px;
    margin-bottom: 20px;
  }

  .ad-safe-spacing--middle {
    margin-top: 10px;
    margin-bottom: 18px;
  }

  .ad-safe-spacing--end {
    margin-top: 14px;
    margin-bottom: 24px;
  }

  .ad-safe-spacing--home {
    margin-top: 6px;
    margin-bottom: 20px;
  }

  .ad-safe-spacing--hub {
    margin-top: 12px;
    margin-bottom: 14px;
  }

  .content-title {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 6px;
  }

  .content-icon {
    width: 34px;
    height: 34px;
    display: grid;
    place-items: center;
    border-radius: 12px;
    background: rgba(23, 20, 18, 0.08);
    color: var(--accent);
  }

  .content-icon svg {
    width: 18px;
    height: 18px;
    stroke: currentColor;
    fill: none;
    stroke-width: 1.6;
  }

  .content-emphasis {
    margin: 0 0 8px;
    font-family: "Fraunces", serif;
    font-size: 1.12rem;
    letter-spacing: 0.01em;
    color: var(--ink-strong);
    background: linear-gradient(90deg, rgba(124, 92, 255, 0.12), rgba(124, 92, 255, 0));
    border-left: 3px solid var(--content-accent, rgba(124, 92, 255, 0.45));
    padding: 8px 10px;
    border-radius: 10px;
  }

  .content-block[data-tone="sea"] {
    --content-accent: #2a9fbf;
  }

  .content-block[data-tone="gold"] {
    --content-accent: #e89b4e;
  }

  .content-block[data-tone="spice"] {
    --content-accent: #d16b4a;
  }

  .content-block[data-tone="lilac"] {
    --content-accent: #9f8ed6;
  }

  .content-block[data-tone="mint"] {
    --content-accent: #4fb79a;
  }

  .content-block[data-tone="sky"] {
    --content-accent: #5aa0dc;
  }

  .content-block[data-tone="sand"] {
    --content-accent: #d6b176;
  }

  .content-block[data-tone="amber"] {
    --content-accent: #f0b352;
  }

  .content-block[data-icon-align="center"] .content-title {
    flex-direction: row;
    align-items: center;
    justify-content: center;
    width: fit-content;
    margin-left: auto;
    margin-right: auto;
    text-align: center;
    gap: 8px;
  }

  .content-block[data-icon-align="center"] .content-title h4 {
    margin: 0;
    text-align: center;
  }


  .pill-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }

  .pill {
    padding: 10px 16px;
    border-radius: 999px;
    background: var(--paper);
    color: var(--ink-strong);
    font-weight: 600;
    border: 1px solid var(--border-paper);
    box-shadow: var(--shadow-1);
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, color 0.2s ease;
  }

  .pill:hover {
    transform: translateY(-2px);
    color: var(--accent-hover);
    box-shadow: var(--shadow-2);
    border-color: rgba(124, 92, 255, 0.25);
  }

  .section-header a,
  .lead a,
  .answer a,
  .content-block a {
    color: var(--accent);
  }

  .section-header a:hover,
  .lead a:hover,
  .answer a:hover,
  .content-block a:hover {
    color: var(--accent-hover);
  }


  @media (max-width: 900px) {
    .hero {
      gap: 10px;
    }

    .hero-tools {
      justify-content: center;
    }

    .lang-switcher {
      flex-wrap: wrap;
      justify-content: center;
      border-radius: 18px;
      padding: 10px 12px;
    }

    .lang-label {
      width: 100%;
      text-align: center;
    }

    .grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 18px;
    }

    .hub-faq {
      margin-top: 20px;
      padding: 16px;
    }

    .hub-faq-list {
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .hub-faq-item {
      padding: 12px;
    }

    .leaf-faq {
      margin-top: 18px;
      padding: 14px;
    }

    .leaf-faq-item {
      padding: 10px 11px;
    }

    .leaf-meta {
      font-size: 0.86rem;
      padding: 8px 10px;
    }

    .home-update-bar {
      grid-template-columns: auto minmax(0, 1fr);
      gap: 6px;
      min-height: 42px;
      padding: 6px 8px;
    }

    .home-update-label {
      font-size: 0.72rem;
      padding: 2px 6px;
      box-shadow: none;
    }

    .home-update-label::before {
      width: 6px;
      height: 6px;
      box-shadow: 0 0 0 3px rgba(45, 127, 249, 0.18);
    }

    .home-update-view {
      height: 1.15rem;
    }

    .home-update-leaf {
      font-size: 0.77rem;
    }

    .home-update-detail {
      font-size: 0.75rem;
    }

    .thumb {
      height: 120px;
    }
  }

  @media (max-width: 600px) {
    .hero {
      padding: 22px 16px;
    }

    h1 {
      font-size: clamp(28px, 7vw, 38px);
      padding: 0 8px;
    }

    .lead {
      font-size: 0.98rem;
      padding: 0 12px;
    }

    .lang-option {
      min-width: 74px;
      padding: 8px 12px;
    }

    .grid {
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .card {
      padding: 18px 18px;
    }

    .thumb {
      height: 110px;
    }

    .card-body {
      gap: 12px;
    }

    .answer-hero {
      grid-template-columns: 1fr;
    }

    .feedback-cta {
      margin-top: 18px;
      padding-top: 16px;
    }
  }
</style>
