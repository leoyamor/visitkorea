  name: Submit Sitemap On Real Lastmod Change

  on:
    push:
      branches:
        - main
      paths:
        - src/data/siteTree.ts
        - src/pages/**
        - src/pages/es/**
        - src/data/page-updates.json
        - scripts/sync-page-updates.mjs
    workflow_dispatch:

  permissions:
    contents: read

  jobs:
    submit-if-lastmod-changed:
      runs-on: ubuntu-latest
      env:
        GSC_SITE_URL: ${{ vars.GSC_SITE_URL }}
        GSC_SERVICE_ACCOUNT_KEY_JSON: ${{ secrets.GSC_SERVICE_ACCOUNT_KEY_JSON }}
        GSC_SITEMAP_URL: ${{ vars.GSC_SITEMAP_URL }}

      steps:
        - name: Checkout
          uses: actions/checkout@v4
          with:
            fetch-depth: 2

        - name: Setup Node
          uses: actions/setup-node@v4
          with:
            node-version: "20"
            cache: npm

        - name: Install dependencies
          run: npm ci

        - name: Sync page updates
          run: npm run page-updates:sync

        - name: Detect page lastmod change
          id: detect
          shell: bash
          run: |
            set -euo pipefail
            if git diff --quiet -- src/data/page-updates.json; then
              echo "should_submit=false" >> "$GITHUB_OUTPUT"
              echo "no lastmod changes"
            else
              echo "should_submit=true" >> "$GITHUB_OUTPUT"
              echo "lastmod changed"
            fi

        - name: Submit sitemap when needed
          shell: bash
          run: |
            set -euo pipefail

            if [ "${{ steps.detect.outputs.should_submit }}" != "true" ]; then
              echo "skip: no lastmod change"
              exit 0
            fi

            if [ -z "$GSC_SITE_URL" ] || [ -z "$GSC_SERVICE_ACCOUNT_KEY_JSON" ]; then
              echo "skip: GSC settings missing"
              exit 0
            fi

            if [ ! -f scripts/gsc-submit-sitemap.mjs ]; then
              echo "skip: scripts/gsc-submit-sitemap.mjs not found"
              exit 0
            fi

            node scripts/gsc-submit-sitemap.mjs