  name: SEO GEO Daily Ops

  on:
    schedule:
      - cron: "17 2 * * *"
    workflow_dispatch:

  permissions:
    contents: write
    pull-requests: write

  jobs:
    daily-ops:
      runs-on: ubuntu-latest
      env:
        GSC_SITE_URL: ${{ vars.GSC_SITE_URL }}
        GSC_SERVICE_ACCOUNT_KEY_JSON: ${{ secrets.GSC_SERVICE_ACCOUNT_KEY_JSON }}
        GSC_SITEMAP_URL: ${{ vars.GSC_SITEMAP_URL }}

      steps:
        - name: Checkout
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Setup Node
          uses: actions/setup-node@v4
          with:
            node-version: "20"
            cache: npm

        - name: Install dependencies
          run: npm ci

        - name: Build
          run: npm run build

        - name: SEO GEO lint
          run: node scripts/seo-geo-lint.mjs

        - name: Source watch snapshot refresh
          run: node scripts/source-watch.mjs --write --report src/data/source-watch-report.md

        - name: Submit sitemap to Google Search Console
          if: ${{ env.GSC_SITE_URL != '' && env.GSC_SERVICE_ACCOUNT_KEY_JSON != '' }}
          run: node scripts/gsc-submit-sitemap.mjs

        - name: Create maintenance pull request
          uses: peter-evans/create-pull-request@v6
          with:
            commit-message: "chore(seo-geo): daily automated refresh"
            branch: "chore/seo-geo-daily"
            delete-branch: true
            title: "chore(seo-geo): daily automated refresh"
            body: |
              Automated maintenance for SEO/GEO reliability.

              Updates include:
              - source watch snapshot refresh
              - source watch report refresh
              - build + SEO/GEO lint verification
            labels: |
              automation
              seo
              geo