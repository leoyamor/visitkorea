---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import TreePage from "../../../components/TreePage.astro";
import type { TreeNode } from "../../../data/siteTree";
import { buildLeafSchemaNodes } from "../../../lib/geo";
import { withLang } from "../../../lib/i18n";
import { absoluteUrl } from "../../../lib/site";
import {
  getLegalPageBySlug,
  legalPages,
  legalSections,
} from "../../../lib/legal-pages";

export const getStaticPaths = () =>
  legalPages.map((page) => ({
    params: { legal: page.slug },
  }));

const { legal } = Astro.params;
const entry = getLegalPageBySlug(legal ?? "");

if (!entry) {
  Astro.response.status = 404;
}

const lang = "es";
const siteName = "Planificador de viaje a Corea";
const fallbackTitle = "Página no encontrada";
const fallbackDescription = "La página que buscas no existe.";

const routePath = entry?.path ?? "/404";
const pageTitle = `${entry ? entry.titleEs : fallbackTitle} | ${siteName}`;
const pageDescription = entry
  ? entry.descriptionEs
  : fallbackDescription;
const canonicalUrl = absoluteUrl(withLang(routePath, lang));
const alternateEnUrl = absoluteUrl(routePath);
const alternateEsUrl = canonicalUrl;

const node: TreeNode = entry
  ? {
      title: entry.titleEs,
      slug: entry.slug,
      description: pageDescription,
      quickAnswer: pageDescription,
      content: legalSections.map((section) => ({
        title: section.titleEs,
        body: section.bodyEs,
        bullets: section.bulletsEs,
        icon: section.icon,
      })),
    }
  : {
      title: fallbackTitle,
      slug: "404",
      description: fallbackDescription,
      quickAnswer: fallbackDescription,
    };

const pageBreadcrumbs = entry
  ? [{ label: entry.titleEs, path: withLang(entry.path, lang) }]
  : [];
const schemaNodes = entry
  ? buildLeafSchemaNodes({
      canonicalUrl,
      node,
      lang,
      description: pageDescription,
      segments: [entry.slug],
    })
  : [];
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  bodyClass="page--leaf"
  lang={lang}
  canonicalUrl={canonicalUrl}
  alternateEnUrl={alternateEnUrl}
  alternateEsUrl={alternateEsUrl}
  breadcrumbs={pageBreadcrumbs}
  schemaNodes={schemaNodes}
  noindex={!entry}
>
  <TreePage
    node={node}
    segments={entry ? [entry.slug] : []}
    parentPath={withLang("/", lang)}
    breadcrumbs={pageBreadcrumbs}
    lang={lang}
  />
</BaseLayout>
