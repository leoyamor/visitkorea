  name: SEO GEO Daily Ops

  on:
    schedule:
      - cron: "17 2 * * 1"
    workflow_dispatch:

  permissions:
    contents: write
    pull-requests: write

  jobs:
    daily-ops:
      runs-on: ubuntu-latest
      env:
        GSC_SITE_URL: ${{ vars.GSC_SITE_URL }}
        GSC_SERVICE_ACCOUNT_KEY_JSON: ${{ secrets.GSC_SERVICE_ACCOUNT_KEY_JSON }}
        GSC_SITEMAP_URL: ${{ vars.GSC_SITEMAP_URL }}

      steps:
        - name: Checkout
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Setup Node
          uses: actions/setup-node@v4
          with:
            node-version: "20"
            cache: npm

        - name: Install dependencies
          run: npm ci

        - name: Build
          run: npm run build

        - name: SEO GEO lint (optional)
          run: |
            if [ -f scripts/seo-geo-lint.mjs ]; then
              node scripts/seo-geo-lint.mjs
            else
              echo "skip: scripts/seo-geo-lint.mjs not found"
            fi

        - name: Source watch snapshot refresh (internal path)
          run: |
            if [ -f scripts/source-watch.mjs ]; then
              node scripts/source-watch.mjs --write --snapshot .ops/source-watch-snapshot.json --report .ops/source-watch-report.md
            else
              echo "skip: scripts/source-watch.mjs not found"
            fi

        - name: Submit sitemap to Google Search Console (optional)
          run: |
            if [ -z "$GSC_SITE_URL" ] || [ -z "$GSC_SERVICE_ACCOUNT_KEY_JSON" ]; then
              echo "skip: GSC vars/secrets not configured"
            elif [ ! -f scripts/gsc-submit-sitemap.mjs ]; then
              echo "skip: scripts/gsc-submit-sitemap.mjs not found"
            else
              node scripts/gsc-submit-sitemap.mjs
            fi

        - name: Create maintenance pull request
          uses: peter-evans/create-pull-request@v6
          with:
            commit-message: "chore(seo-geo): automated refresh"
            branch: "chore/seo-geo-daily"
            delete-branch: true
            title: "chore(seo-geo): automated refresh"
            body: |
              Automated maintenance for SEO/GEO reliability.
            labels: |
              automation
              seo
              geo