---
import type { TreeNode } from "../data/siteTree";

type Props = {
  node: TreeNode;
  segments: string[];
  parentPath: string;
  isHome?: boolean;
  breadcrumbs?: { label: string; path: string }[];
};

const { node, segments, parentPath, isHome = false, breadcrumbs = [] } =
  Astro.props as Props;

const basePath = segments.length ? `/${segments.join("/")}` : "";
const children = node.children ?? [];
const hasChildren = children.length > 0;

const getInitials = (title: string) => {
  const words = title.replace(/[?]/g, "").split(" ").filter(Boolean);
  const letters = words.map((word) => word[0]);
  return letters.slice(0, 2).join("").toUpperCase();
};

const iconMap: Record<string, string> = {
  calendar:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 2v3M17 2v3M3.5 9h17M5 6h14a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2Z"/><path d="M8 12h3M13 12h3M8 16h3M13 16h3"/></svg>',
  compass:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="8"/><path d="M14.8 9.2 9.7 11l-1.5 4.3 5.1-1.8 1.5-4.3Z"/><circle cx="12" cy="12" r="1.4"/></svg>',
  spark:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3 9.7 8.3 4 10l5.7 1.7L12 17l2.3-5.3L20 10l-5.7-1.7L12 3Z"/></svg>',
  city:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 20V7l6-3v16M14 20V4l6 3v13"/><path d="M7.5 10h2M7.5 13.5h2M16.5 10h2M16.5 13.5h2"/></svg>',
  beach:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 20c4-4 12-4 16 0"/><path d="M6 13l8-6 2 3-8 6-2-3Z"/><path d="M14 7 11 3"/></svg>',
  island:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 20c2-3 6-4 9-4s7 1 9 4"/><path d="M8 14c1-3 3-5 6-5"/><path d="M14 9c1-2 2-3 3-3"/><circle cx="8" cy="7" r="1.5"/></svg>',
  temple:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 11h18M5 11l7-5 7 5"/><path d="M6 11v7M18 11v7M4 18h16"/></svg>',
  bowl:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 13c0 4 3.6 7 8 7s8-3 8-7H4Z"/><path d="M7 6c0 2 2 2 2 4M12 5c0 2 2 2 2 4M17 6c0 2-2 2-2 4"/></svg>',
  leaf:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 18c7 0 12-5 14-12-7 2-12 7-12 14 0 1.5 0 2 0 2"/><path d="M8 14c2 0 4-2 6-4"/></svg>',
  pin:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 21s6-6 6-11a6 6 0 1 0-12 0c0 5 6 11 6 11Z"/><circle cx="12" cy="10" r="2"/></svg>',
  chili:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15 7c-2-1-5 0-7 3-2 3-2 7 1 8 3 1 7-1 9-4 2-3 1-6-3-7Z"/><path d="M14 6c1-2 3-3 5-2"/></svg>',
  train:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 17V7a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v10"/><path d="M6 17h12l-2 3M8 20l-2-3"/><circle cx="9" cy="12" r="1.5"/><circle cx="15" cy="12" r="1.5"/></svg>',
  bus:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="5" y="4" width="14" height="14" rx="3"/><path d="M7 9h10M7 12h10"/><circle cx="8.5" cy="18" r="1.5"/><circle cx="15.5" cy="18" r="1.5"/></svg>',
  taxi:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 11 8 6h8l2 5"/><rect x="4" y="11" width="16" height="7" rx="2"/><circle cx="8" cy="18" r="1.5"/><circle cx="16" cy="18" r="1.5"/></svg>',
  car:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 14 6 8h12l2 6"/><rect x="3" y="14" width="18" height="5" rx="2"/><circle cx="7.5" cy="19" r="1.5"/><circle cx="16.5" cy="19" r="1.5"/></svg>',
  card:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="4" y="6" width="16" height="12" rx="2"/><path d="M4 10h16M7 14h5"/></svg>',
  wallet:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="3" y="7" width="18" height="12" rx="3"/><path d="M16 11h5v4h-5a2 2 0 0 1 0-4Z"/></svg>',
  transfer:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 7h10l-2-2M17 7l-2 2"/><path d="M17 17H7l2 2M7 17l2-2"/></svg>',
  bed:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="4" y="10" width="16" height="7" rx="2"/><path d="M6 10V8a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M4 17v3M20 17v3"/></svg>',
  sim:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 4h6l4 4v12H8V4Z"/><path d="M10 9h4M10 12h4M10 15h4"/></svg>',
  shield:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3 19 6v6c0 5-4 8-7 9-3-1-7-4-7-9V6l7-3Z"/><path d="m9 12 2 2 4-4"/></svg>',
  alert:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="m12 3 9 16H3L12 3Z"/><path d="M12 9v4M12 17h.01"/></svg>',
  passport:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="6" y="4" width="12" height="16" rx="2"/><circle cx="12" cy="11" r="2.5"/><path d="M9 16h6"/></svg>',
  hand:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 11V6a1.5 1.5 0 0 1 3 0v5"/><path d="M11 11V5a1.5 1.5 0 0 1 3 0v6"/><path d="M14 11V6a1.5 1.5 0 0 1 3 0v8a6 6 0 0 1-6 6H9a4 4 0 0 1-4-4v-5a2 2 0 0 1 4 0v1"/></svg>',
  checklist:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="6" y="4" width="12" height="16" rx="2"/><path d="m9 9 1.5 1.5L13 8"/><path d="M9 13h6M9 16h6"/></svg>',
  plane:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M2 13 22 11 2 9 2 13Z"/><path d="M10 11 6 4M10 13 6 20"/></svg>',
  bag:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="5" y="7" width="14" height="13" rx="2"/><path d="M9 7V6a3 3 0 0 1 6 0v1"/></svg>',
  receipt:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 3h12v18l-2-1-2 1-2-1-2 1-2-1-2 1V3Z"/><path d="M9 8h6M9 12h6M9 16h4"/></svg>',
  tag:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M10 4H4v6l8 8 6-6-8-8Z"/><circle cx="7" cy="7" r="1.5"/></svg>',
  route:
    '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M19 21a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M7 5h5a4 4 0 0 1 0 8H9a4 4 0 0 0 0 8h5"/></svg>',
};

const toneMap: Record<string, string> = {
  calendar: "sunset",
  compass: "sky",
  spark: "gold",
  city: "slate",
  beach: "sea",
  island: "sea",
  temple: "sand",
  bowl: "spice",
  leaf: "leaf",
  pin: "rose",
  chili: "chili",
  train: "steel",
  bus: "steel",
  taxi: "amber",
  car: "steel",
  card: "mint",
  wallet: "mint",
  transfer: "steel",
  bed: "lilac",
  sim: "sky",
  shield: "steel",
  alert: "chili",
  passport: "slate",
  hand: "sand",
  checklist: "sky",
  plane: "sky",
  bag: "gold",
  receipt: "mint",
  tag: "gold",
  route: "steel",
};

const renderIcon = (key?: string) => {
  if (!key) return null;
  return iconMap[key] ?? null;
};

const escapeHtml = (value: string) =>
  value.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

const keywordLinks: Record<string, string> = {
  "K-ETA": "https://www.k-eta.go.kr",
  "Korean Immigration Service": "https://www.immigration.go.kr",
  "Visit Korea": "https://english.visitkorea.or.kr",
  "Korail": "https://www.letskorail.com",
  "Incheon International Airport": "https://www.airport.kr",
  "Seoul Metro": "https://www.seoulmetro.co.kr",
  "Korea Meteorological Administration": "https://www.weather.go.kr",
  "Seoul Tourism Organization": "https://english.visitseoul.net",
  "Busan Tourism Organization": "https://english.busan.go.kr",
  "Jeju Tourism Organization": "https://english.visitjeju.net",
  "Gyeongju Tourism": "https://www.gyeongju.go.kr",
  "Ministry of Foreign Affairs": "https://www.mofa.go.kr",
  "Global Tax Free Korea": "https://www.globaltaxfree.com",
  "Korea Customs Service": "https://www.customs.go.kr",
};

const getUrlLabel = (url: string) => {
  try {
    const { hostname } = new URL(url);
    return hostname.replace(/^www\./, "");
  } catch {
    return url;
  }
};

const linkify = (text: string) => {
  const escaped = escapeHtml(text);
  const withUrls = escaped.replace(/(https?:\/\/[^\s]+)/g, (url) => {
    const safeUrl = url.replace(/"/g, "&quot;");
    const label = getUrlLabel(url);
    return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${label}</a>`;
  });

  const parts = withUrls.split(/(<a\b[^>]*>.*?<\/a>)/g);
  return parts
    .map((part) => {
      if (part.startsWith("<a")) return part;
      let next = part;
      for (const [keyword, href] of Object.entries(keywordLinks)) {
        const safeHref = href.replace(/"/g, "&quot;");
        const pattern = new RegExp(`\\b${keyword.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")}\\b`, "g");
        next = next.replace(
          pattern,
          `<a href="${safeHref}" target="_blank" rel="noopener noreferrer">${keyword}</a>`
        );
      }
      return next;
    })
    .join("");
};

const getTone = (key?: string) => {
  if (!key) return "default";
  return toneMap[key] ?? "default";
};

const toDataUri = (svg: string) =>
  `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;

const imageSvgs: Record<string, string> = {
  planning: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#f2d2a2"/>
          <stop offset="100%" stop-color="#f7b267"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <rect x="52" y="48" width="256" height="134" rx="18" fill="#fff" opacity="0.78"/>
      <rect x="72" y="78" width="70" height="18" rx="6" fill="#f2b880"/>
      <rect x="72" y="108" width="140" height="14" rx="6" fill="#f4c7a0"/>
      <rect x="72" y="132" width="180" height="14" rx="6" fill="#f4c7a0"/>
      <rect x="72" y="156" width="120" height="14" rx="6" fill="#f4c7a0"/>
      <circle cx="250" cy="90" r="22" fill="#f7b267"/>
    </svg>
  `,
  city: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#c5d6f6"/>
          <stop offset="100%" stop-color="#7aa2d7"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <rect x="70" y="70" width="52" height="90" rx="6" fill="#1f3b5c" opacity="0.85"/>
      <rect x="132" y="50" width="70" height="110" rx="6" fill="#2b4d74" opacity="0.9"/>
      <rect x="214" y="80" width="60" height="80" rx="6" fill="#375f8c" opacity="0.9"/>
      <rect x="90" y="90" width="16" height="12" rx="3" fill="#d9e7ff"/>
      <rect x="90" y="110" width="16" height="12" rx="3" fill="#d9e7ff"/>
      <rect x="150" y="74" width="18" height="12" rx="3" fill="#d9e7ff"/>
    </svg>
  `,
  beach: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#7dd3fc"/>
          <stop offset="100%" stop-color="#38bdf8"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <circle cx="80" cy="70" r="26" fill="#fde68a"/>
      <path d="M0 150c60-20 120-20 180 0s120 20 180 0v70H0Z" fill="#f9e1b2"/>
      <path d="M0 130c60-15 120-15 180 0s120 15 180 0" fill="none" stroke="#e0f2fe" stroke-width="8"/>
    </svg>
  `,
  island: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#4cc9f0"/>
          <stop offset="100%" stop-color="#90dbf4"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <path d="M90 160c20-30 50-45 90-45s70 15 90 45" fill="#f8d8a8"/>
      <path d="M150 140c10-26 30-40 60-40" fill="none" stroke="#2a9d8f" stroke-width="10" stroke-linecap="round"/>
      <path d="M210 100c5-18 20-26 40-22" fill="none" stroke="#2a9d8f" stroke-width="8" stroke-linecap="round"/>
    </svg>
  `,
  heritage: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#f3d5b5"/>
          <stop offset="100%" stop-color="#d4a373"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <path d="M80 140h200l-20-60-80-30-80 30-20 60Z" fill="#9c6644" opacity="0.9"/>
      <rect x="110" y="140" width="140" height="40" rx="6" fill="#7f5539"/>
      <rect x="155" y="120" width="50" height="60" rx="6" fill="#fefae0" opacity="0.9"/>
    </svg>
  `,
  food: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#ffd6a5"/>
          <stop offset="100%" stop-color="#fd7f6f"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <path d="M90 140c0 36 36 60 90 60s90-24 90-60H90Z" fill="#fff" opacity="0.8"/>
      <path d="M120 110c0 20 20 20 20 40M170 100c0 20 20 20 20 40M220 110c0 20-20 20-20 40" fill="none" stroke="#fff" stroke-width="8" stroke-linecap="round"/>
    </svg>
  `,
  transport: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#94a3b8"/>
          <stop offset="100%" stop-color="#64748b"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <rect x="80" y="70" width="200" height="90" rx="30" fill="#f8fafc" opacity="0.85"/>
      <circle cx="120" cy="150" r="10" fill="#475569"/>
      <circle cx="240" cy="150" r="10" fill="#475569"/>
      <rect x="120" y="90" width="120" height="16" rx="8" fill="#94a3b8"/>
    </svg>
  `,
  stay: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#cdb4db"/>
          <stop offset="100%" stop-color="#9d76c1"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <rect x="70" y="110" width="220" height="60" rx="18" fill="#fff" opacity="0.8"/>
      <rect x="90" y="90" width="90" height="30" rx="12" fill="#f1e6ff"/>
      <rect x="70" y="160" width="220" height="12" rx="6" fill="#7c4ca2" opacity="0.7"/>
    </svg>
  `,
  basics: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#bde0fe"/>
          <stop offset="100%" stop-color="#8ecae6"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <circle cx="180" cy="110" r="60" fill="#fff" opacity="0.8"/>
      <path d="M180 70l20 50-50-20 30-30Z" fill="#219ebc" opacity="0.9"/>
      <circle cx="180" cy="110" r="8" fill="#023047"/>
    </svg>
  `,
  shopping: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#ffb703"/>
          <stop offset="100%" stop-color="#fb8500"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <rect x="110" y="80" width="140" height="110" rx="16" fill="#fff" opacity="0.8"/>
      <path d="M140 80v-12a20 20 0 0 1 40 0v12" fill="none" stroke="#ffb703" stroke-width="10" stroke-linecap="round"/>
      <circle cx="155" cy="125" r="8" fill="#fb8500"/>
      <circle cx="205" cy="125" r="8" fill="#fb8500"/>
    </svg>
  `,
  safety: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#adb5bd"/>
          <stop offset="100%" stop-color="#6c757d"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <path d="M180 60l80 30v50c0 40-30 64-80 80-50-16-80-40-80-80V90l80-30Z" fill="#fff" opacity="0.8"/>
      <path d="m150 130 20 20 40-40" fill="none" stroke="#6c757d" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  `,
  airport: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 220">
      <defs>
        <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#90e0ef"/>
          <stop offset="100%" stop-color="#48cae4"/>
        </linearGradient>
      </defs>
      <rect width="360" height="220" rx="28" fill="url(#grad)"/>
      <path d="M60 120l240-20-240-20v40Z" fill="#fff" opacity="0.85"/>
      <path d="M150 100l-30-50M150 120l-30 50" stroke="#00b4d8" stroke-width="10" stroke-linecap="round"/>
      <circle cx="270" cy="70" r="16" fill="#fff" opacity="0.7"/>
    </svg>
  `,
};

const imageThemeMap: Record<string, string> = {
  planning: "planning",
  city: "city",
  beach: "beach",
  island: "island",
  heritage: "heritage",
  food: "food",
  transport: "transport",
  stay: "stay",
  basics: "basics",
  shopping: "shopping",
  safety: "safety",
  airport: "airport",
};

const getImage = (key?: string) => {
  if (key && (key.startsWith("/") || key.includes(".webp"))) {
    return key;
  }
  const theme = key ? imageThemeMap[key] ?? "basics" : "basics";
  const svg = imageSvgs[theme] ?? imageSvgs.basics;
  return toDataUri(svg);
};

const breadcrumb = breadcrumbs;
---

<section class="hero">
  <div>
    <p class="eyebrow">Visit Korea Planner</p>
    <h1 class="t-h1">{isHome ? "Your Simple Guide to Traveling in Korea" : node.title}</h1>
    {!isHome && (
      <div class="nav-links">
        <a href={parentPath} aria-label="Back to previous page">← Back</a>
        <span class="nav-sep" aria-hidden="true">·</span>
        <a href="/" aria-label="Go to home">Home</a>
      </div>
    )}
    <p class="lead t-subheading">
      {isHome ? (
        <>
          No overload, no confusion.
          <br />
          Just clear answers to help you plan, get around, eat well, and enjoy Korea.
        </>
      ) : (
        node.description ?? "Explore the next set of guides."
      )}
    </p>
  </div>
</section>

<section class="section">
  <div class="section-header">
    <h2 class="t-section">{isHome ? "Start here" : hasChildren ? "Pick a sub page" : "Quick answer"}</h2>
    <p>
      {isHome
        ? "Begin with a category, then drill down to detailed tips."
        : hasChildren
        ? "Each card opens a focused guide."
        : node.quickAnswer ?? "Here is the short description, with more detail to be added later."}
    </p>
  </div>

  {hasChildren ? (
    <div class="grid">
      {children.map((child) => (
        <a class="card" href={`${basePath}/${child.slug}`} data-tone={getTone(child.icon)}>
          <div class="thumb" style={`--thumb: url(${getImage(child.image ?? child.icon)})`}>
            <span class="thumb-mask" aria-hidden="true"></span>
          </div>
          <div class="card-body">
            <div>
              <h3 class="t-card-title">{child.title}</h3>
              <p class="t-card-desc">{child.description ?? "Short summary coming soon."}</p>
            </div>
          </div>
        </a>
      ))}
    </div>
  ) : (
    <div class="answer">
      <div class="answer-hero">
        <div class="answer-thumb" style={`--thumb: url(${getImage(node.image ?? node.icon)})`}>
          <span class="thumb-mask" aria-hidden="true"></span>
        </div>
        <div>
          <h3 class="t-section">{node.title}</h3>
          <p class="t-subheading">{node.description ?? "This guide is being prepared."}</p>
        </div>
      </div>
      {node.content?.map((section) => (
        <div class="content-block" data-tone={getTone(section.icon)}>
          <div class="content-title">
            {section.icon && (
              <span class="content-icon" set:html={renderIcon(section.icon)} />
            )}
            <h4 class="t-section">{section.title}</h4>
          </div>
          {section.emphasis && (
            <p class="content-emphasis">{section.emphasis}</p>
          )}
          <p set:html={linkify(section.body)} />
          {section.bullets && (
            <ul>
              {section.bullets.map((bullet) => (
                <li set:html={linkify(bullet)} />
              ))}
            </ul>
          )}
        </div>
      ))}
      <div class="content-identity">
        <span class="content-identity-icon" aria-hidden="true" set:html={renderIcon("spark")} />
        <span>This site helps you decide what fits your trip — not just list information.</span>
      </div>
    </div>
  )}
</section>

{isHome && (
  <section class="section light">
    <div class="section-header">
      <h2 class="t-section">Not sure where to go next?</h2>
      <p>Try these dependable starting points for first-time travelers.</p>
    </div>
    <div class="pill-row">
      <a class="pill" href="/plan-your-trip/7-days-in-korea">7 Days in Korea</a>
      <a class="pill" href="/travel-basics/sim-or-esim">SIM or eSIM?</a>
      <a class="pill" href="/getting-around-korea/using-the-subway">Using the Subway</a>
      <a class="pill" href="/choose-a-city/which-city-fits-you-best">Which City Fits You Best?</a>
    </div>
  </section>
)}

<style>
  .hero {
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: center;
    text-align: center;
    margin-bottom: 36px;
  }

  .eyebrow {
    text-transform: uppercase;
    font-size: 12px;
    letter-spacing: 0.18em;
    color: var(--muted);
    margin-bottom: 12px;
  }

  h1 {
    font-family: "Fraunces", serif;
    margin: 0 0 10px;
    color: var(--ink);
    max-width: 720px;
    white-space: normal;
    line-height: 1.1;
    overflow-wrap: anywhere;
  }

  .lead {
    color: var(--ink-soft);
    margin: 0 0 20px;
    max-width: 680px;
    line-height: 1.5;
  }

  .button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 10px 18px;
    border-radius: 999px;
    background: var(--accent);
    color: #fff;
    font-weight: 600;
    border: 1px solid transparent;
    box-shadow: 0 12px 25px rgba(19, 86, 108, 0.18);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .button:hover {
    transform: translateY(-2px);
    box-shadow: 0 16px 30px rgba(19, 86, 108, 0.22);
  }

  .button.ghost {
    background: transparent;
    color: var(--accent-strong);
    border-color: var(--ring);
    box-shadow: none;
  }

  .nav-links {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    font-size: 0.95rem;
    color: var(--muted);
    margin: 6px 0 14px;
  }

  .nav-links a {
    color: var(--muted);
    text-decoration: none;
    font-weight: 600;
  }

  .nav-links a:hover {
    color: var(--accent-strong);
  }

  .nav-sep {
    color: var(--muted);
  }

  .breadcrumbs {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    font-size: 0.9rem;
    color: var(--muted);
    margin-bottom: 26px;
  }

  .breadcrumbs a {
    color: var(--muted);
  }

  .crumb {
    color: var(--muted);
  }

  .crumb-group {
    display: inline-flex;
    gap: 8px;
    align-items: center;
  }

  .section {
    margin-bottom: 48px;
  }


  .section-header {
    margin-bottom: 24px;
  }

  .section-header h2 {
    margin: 0 0 8px;
    font-family: "Fraunces", serif;
  }

  .section-header p {
    margin: 0;
    color: var(--muted);
  }

  .section.light {
    background: rgba(255, 255, 255, 0.7);
    padding: 28px 32px;
    border-radius: 24px;
    box-shadow: var(--shadow);
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 20px;
  }

  .card {
    display: grid;
    grid-template-rows: auto 1fr;
    gap: 14px;
    padding: 20px 22px;
    background: var(--card);
    border-radius: 20px;
    border: 1px solid rgba(31, 111, 139, 0.12);
    box-shadow: 0 10px 30px rgba(15, 32, 60, 0.1);
    transition: transform 0.2s ease, border-color 0.2s ease;
    position: relative;
    overflow: hidden;
  }

  .card:hover {
    transform: translateY(-4px);
    border-color: var(--ring);
  }

  .card::after {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.5), transparent 65%);
    opacity: 0.6;
    pointer-events: none;
  }

  .card[data-tone="sea"]::after {
    background: radial-gradient(circle at 80% 0%, rgba(90, 178, 206, 0.35), transparent 65%);
  }

  .card[data-tone="gold"]::after {
    background: radial-gradient(circle at 80% 0%, rgba(245, 163, 91, 0.35), transparent 65%);
  }

  .card[data-tone="spice"]::after {
    background: radial-gradient(circle at 80% 0%, rgba(214, 101, 68, 0.35), transparent 65%);
  }

  .card[data-tone="lilac"]::after {
    background: radial-gradient(circle at 80% 0%, rgba(161, 150, 221, 0.35), transparent 65%);
  }

  .card[data-tone="mint"]::after {
    background: radial-gradient(circle at 80% 0%, rgba(105, 196, 176, 0.35), transparent 65%);
  }

  .card[data-tone="sky"]::after {
    background: radial-gradient(circle at 80% 0%, rgba(129, 183, 231, 0.35), transparent 65%);
  }

  .card[data-tone="sand"]::after {
    background: radial-gradient(circle at 80% 0%, rgba(234, 200, 148, 0.35), transparent 65%);
  }

  .card[data-tone="amber"]::after {
    background: radial-gradient(circle at 80% 0%, rgba(255, 200, 96, 0.35), transparent 65%);
  }

  .thumb {
    width: 100%;
    height: 128px;
    border-radius: 16px;
    background: var(--paper-strong);
    background-image: var(--thumb);
    background-size: cover;
    background-position: center;
    position: relative;
    overflow: hidden;
  }

  .thumb-mask {
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.05), rgba(15, 32, 60, 0.08));
  }

  .card-body {
    display: block;
  }

  .card h3 {
    margin: 0 0 6px;
  }

  .card p {
    margin: 0;
    color: var(--muted);
  }


  .answer {
    display: flex;
    flex-direction: column;
    gap: 18px;
    padding: 22px;
    border-radius: 22px;
    background: var(--card);
    border: 1px solid rgba(31, 111, 139, 0.12);
    box-shadow: var(--shadow);
  }

  .answer-hero {
    display: grid;
    grid-template-columns: minmax(0, 200px) 1fr;
    gap: 18px;
    align-items: center;
  }

  .answer-thumb {
    width: 100%;
    height: 140px;
    border-radius: 18px;
    background: var(--paper-strong);
    background-image: var(--thumb);
    background-size: cover;
    background-position: center;
    position: relative;
    overflow: hidden;
  }

  .answer h3 {
    margin: 0 0 8px;
  }

  .answer p {
    margin: 0;
    color: var(--muted);
    line-height: 1.6;
  }

  .content-block h4 {
    margin: 0 0 6px;
    font-size: 1.05rem;
    color: var(--ink);
  }

  .content-block p {
    margin: 0 0 8px;
    color: var(--muted);
    line-height: 1.7;
  }

  .content-block ul {
    margin: 0;
    padding-left: 18px;
    color: var(--ink-soft);
    line-height: 1.6;
  }

  .content-block {
    position: relative;
    padding: 16px 18px 16px 20px;
    border-radius: 16px;
    background: rgba(255, 255, 255, 0.65);
    border: 1px solid rgba(31, 111, 139, 0.1);
    box-shadow: 0 10px 24px rgba(15, 32, 60, 0.08);
  }

  .content-block::before {
    content: "";
    position: absolute;
    left: 0;
    top: 10px;
    bottom: 10px;
    width: 4px;
    border-radius: 999px;
    background: var(--content-accent, var(--ring));
  }
  .content-identity {
    margin-top: 28px;
    padding: 16px 18px;
    border-radius: 14px;
    background: #f7f2ea;
    color: #4a3f34;
    font-size: 15px;
    line-height: 1.6;
    text-align: center;
    box-shadow: 0 10px 30px rgba(66, 46, 20, 0.12);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }
  .content-identity-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    color: #c98735;
  }
  .content-identity-icon svg {
    width: 18px;
    height: 18px;
    stroke: currentColor;
    fill: none;
    stroke-width: 1.6;
  }

  .content-title {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 6px;
  }

  .content-icon {
    width: 34px;
    height: 34px;
    display: grid;
    place-items: center;
    border-radius: 12px;
    background: rgba(31, 111, 139, 0.1);
    color: var(--accent-strong);
  }

  .content-icon svg {
    width: 18px;
    height: 18px;
    stroke: currentColor;
    fill: none;
    stroke-width: 1.6;
  }

  .content-emphasis {
    margin: 0 0 8px;
    font-family: "Fraunces", serif;
    font-size: 1.12rem;
    letter-spacing: 0.01em;
    color: var(--ink);
    background: linear-gradient(90deg, rgba(31, 111, 139, 0.12), rgba(31, 111, 139, 0));
    border-left: 3px solid var(--content-accent, var(--ring));
    padding: 8px 10px;
    border-radius: 10px;
  }

  .content-block[data-tone="sea"] {
    --content-accent: #2a9fbf;
  }

  .content-block[data-tone="gold"] {
    --content-accent: #e89b4e;
  }

  .content-block[data-tone="spice"] {
    --content-accent: #d16b4a;
  }

  .content-block[data-tone="lilac"] {
    --content-accent: #9f8ed6;
  }

  .content-block[data-tone="mint"] {
    --content-accent: #4fb79a;
  }

  .content-block[data-tone="sky"] {
    --content-accent: #5aa0dc;
  }

  .content-block[data-tone="sand"] {
    --content-accent: #d6b176;
  }

  .content-block[data-tone="amber"] {
    --content-accent: #f0b352;
  }


  .pill-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }

  .pill {
    padding: 10px 16px;
    border-radius: 999px;
    background: rgba(19, 86, 108, 0.12);
    color: var(--accent-strong);
    font-weight: 600;
    border: 1px solid transparent;
  }

  .pill:hover {
    border-color: var(--ring);
  }


  @media (max-width: 900px) {
    .hero {
      gap: 10px;
    }

    .grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 18px;
    }

    .thumb {
      height: 120px;
    }
  }

  @media (max-width: 600px) {
    h1 {
      font-size: clamp(28px, 7vw, 38px);
      padding: 0 8px;
    }

    .lead {
      font-size: 0.98rem;
      padding: 0 12px;
    }

    .grid {
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .card {
      padding: 18px 18px;
    }

    .thumb {
      height: 110px;
    }

    .card-body {
      gap: 12px;
    }

    .answer-hero {
      grid-template-columns: 1fr;
    }
  }
</style>
