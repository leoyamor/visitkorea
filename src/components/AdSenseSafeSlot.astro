---
import { ADSENSE_CLIENT_ID, getAdSlotByZone, type AdZone } from "../lib/ads";

type Props = {
  zone: AdZone;
  className?: string;
};

const { zone, className = "" } = Astro.props as Props;
const slotId = getAdSlotByZone(zone);
const isEnabled = Boolean(ADSENSE_CLIENT_ID && slotId);
const showPlaceholder = import.meta.env.DEV && !isEnabled;
---

{isEnabled ? (
  <div class={`ad-safe-slot ${className}`} data-ad-zone={zone} data-kpi-section="adsense_slot">
    <p class="ad-safe-label">Advertisement</p>
    <ins
      class="adsbygoogle"
      style="display:block"
      data-ad-client={ADSENSE_CLIENT_ID}
      data-ad-slot={slotId}
      data-ad-format="auto"
      data-full-width-responsive="true"
    />
    <script is:inline define:vars={{ ADSENSE_CLIENT_ID }}>
      (() => {
        const clientId = ADSENSE_CLIENT_ID;
        if (!clientId) return;
        const currentScript = document.currentScript;
        const slotEl =
          currentScript && currentScript.previousElementSibling instanceof HTMLElement
            ? currentScript.previousElementSibling
            : null;

        const enqueue = () => {
          if (!slotEl || slotEl.dataset.adsInit === "1") return;
          slotEl.dataset.adsInit = "1";
          const queue = (window.adsbygoogle = window.adsbygoogle || []);
          queue.push({});
        };

        const loadScript = () => {
          if (window.__adsenseLoaderPromise) {
            return window.__adsenseLoaderPromise;
          }

          const existing = document.querySelector("script[data-adsense-loader]");
          if (existing) {
            window.__adsenseLoaderPromise = Promise.resolve();
            return window.__adsenseLoaderPromise;
          }

          window.__adsenseLoaderPromise = new Promise((resolve, reject) => {
            const script = document.createElement("script");
            script.async = true;
            script.crossOrigin = "anonymous";
            script.src = `https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${clientId}`;
            script.setAttribute("data-adsense-loader", "true");
            script.addEventListener("load", () => resolve(), { once: true });
            script.addEventListener("error", () => reject(new Error("adsense_load_failed")), { once: true });
            document.head.appendChild(script);
          });

          return window.__adsenseLoaderPromise;
        };

        const schedule = () => {
          loadScript()
            .catch(() => null)
            .finally(enqueue);
        };

        const waitForStartSignal = () => {
          if (window.__visitkoreaAdStartPromise) {
            return window.__visitkoreaAdStartPromise;
          }

          window.__visitkoreaAdStartPromise = new Promise((resolve) => {
            let started = false;
            const options = { passive: true };
            const startNow = () => {
              if (started) return;
              started = true;
              cleanup();
              resolve();
            };
            const cleanup = () => {
              window.removeEventListener("pointerdown", startNow, options);
              window.removeEventListener("keydown", startNow, options);
              window.removeEventListener("touchstart", startNow, options);
              window.removeEventListener("scroll", startNow, options);
            };
            const startSoft = () => {
              if (started) return;
              if ("requestIdleCallback" in window) {
                window.requestIdleCallback(startNow, { timeout: 1200 });
                return;
              }
              window.setTimeout(startNow, 500);
            };

            window.addEventListener("pointerdown", startNow, options);
            window.addEventListener("keydown", startNow, options);
            window.addEventListener("touchstart", startNow, options);
            window.addEventListener("scroll", startNow, options);

            if (document.readyState === "complete") {
              startSoft();
            } else {
              window.addEventListener("load", startSoft, { once: true });
            }
            window.setTimeout(startNow, 3500);
          });

          return window.__visitkoreaAdStartPromise;
        };

        const scheduleWhenIdle = () => {
          if ("requestIdleCallback" in window) {
            window.requestIdleCallback(schedule, { timeout: 1200 });
            return;
          }
          window.setTimeout(schedule, 300);
        };

        const waitForSlotSignal = () => {
          if (!("IntersectionObserver" in window) || !slotEl) {
            return Promise.resolve();
          }

          return new Promise((resolve) => {
            let done = false;
            const finish = () => {
              if (done) return;
              done = true;
              observer.disconnect();
              resolve();
            };
            const observer = new IntersectionObserver(
              (entries) => {
                if (!entries.some((entry) => entry.isIntersecting)) return;
                finish();
              },
              { rootMargin: "900px 0px" }
            );
            observer.observe(slotEl);
            window.setTimeout(finish, 4500);
          });
        };

        Promise.all([waitForStartSignal(), waitForSlotSignal()]).then(scheduleWhenIdle);
      })();
    </script>
  </div>
) : showPlaceholder ? (
  <div class={`ad-safe-slot ad-safe-slot--placeholder ${className}`} data-ad-zone={zone} aria-hidden="true">
    <p class="ad-safe-label">Ad template: {zone}</p>
  </div>
) : null}

<style>
  .ad-safe-slot {
    margin: 18px 0;
    padding: 14px 12px;
    border-radius: 14px;
    border: 1px solid rgba(0, 0, 0, 0.08);
    background: rgba(255, 255, 255, 0.72);
  }

  .ad-safe-slot--placeholder {
    border-style: dashed;
    background: rgba(255, 255, 255, 0.46);
  }

  .ad-safe-label {
    margin: 0 0 10px;
    font-size: 0.76rem;
    line-height: 1;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: rgba(46, 42, 38, 0.68);
  }

  @media (max-width: 720px) {
    .ad-safe-slot {
      margin: 14px 0;
      padding: 12px 10px;
    }
  }
</style>
